<!-- üîπ TABS F√ñR ALLA DIVISIONER -->
<div class="ecl-tabs">
  <button class="ecl-tab active" data-division="elite">Elite</button>
  <button class="ecl-tab" data-division="pro">Pro</button>
  <button class="ecl-tab" data-division="lite">Lite</button>
  <button class="ecl-tab" data-division="core">Core</button>
  <button class="ecl-tab" data-division="neo">Neo</button>
</div>

<!-- üîπ ELITE -->
<div id="division-elite" class="division active">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Elite Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-elite" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-elite" class="top3-container"></div>
  <div id="table-elite" class="table-container"></div>
  <p id="updated-elite" class="lastUpdated"></p>
</div>

<!-- üîπ PRO -->
<div id="division-pro" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Pro Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-pro" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-pro" class="top3-container"></div>
  <div id="table-pro" class="table-container"></div>
  <p id="updated-pro" class="lastUpdated"></p>
</div>

<!-- üîπ LITE -->
<div id="division-lite" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Lite Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-lite" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-lite" class="top3-container"></div>
  <div id="table-lite" class="table-container"></div>
  <p id="updated-lite" class="lastUpdated"></p>
</div>

<!-- üîπ CORE -->
<div id="division-core" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Core Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-core" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-core" class="top3-container"></div>
  <div id="table-core" class="table-container"></div>
  <p id="updated-core" class="lastUpdated"></p>
</div>

<!-- üîπ NEO -->
<div id="division-neo" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Neo Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-neo" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-neo" class="top3-container"></div>
  <div id="table-neo" class="table-container"></div>
  <p id="updated-neo" class="lastUpdated"></p>
</div>

<!-- üîπ STIL -->
<style>
/* (EXAKT SAMMA CSS SOM DIN VERSION ‚Äì INTE √ÑNDRAT) */
.ecl-tabs {
  display: flex;
  gap: 6px;
  margin: 10px 0 16px;
  flex-wrap: wrap;
}
.ecl-tab {
  border: none;
  padding: 8px 14px;
  border-radius: 999px;
  font-family: Inter, system-ui, Arial, sans-serif;
  font-size: 14px;
  cursor: pointer;
  background: #f1f3fa;
  color: #202742;
  font-weight: 600;
}
.ecl-tab.active {
  background: #101b40;
  color: #f7e0a2;
}
.division { display: none; }
.division.active { display: block; }

.header-box { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin: 10px 0 20px; gap: 12px; }
.header-box h2 { font-family: Inter, system-ui, Arial, sans-serif; font-size: 24px; font-weight: 800; color: #0b1a49; margin: 0; text-shadow: 0 2px 6px rgba(0,0,0,.08); }
.header-box input[type="text"] { padding: 10px 14px; font-size: 15px; border: 1px solid #ccc; border-radius: 10px; min-width: 240px; outline: none; transition: border-color .2s, box-shadow .2s; }
.header-box input[type="text"]:focus { border-color: #0b1a49; box-shadow: 0 0 0 2px rgba(11,26,73,.15); }

.top3-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-bottom: 18px; }
.player-card { background: #ffffff; border-radius: 16px; padding: 14px 16px; box-shadow: 0 4px 16px rgba(0,0,0,.06); font-family: Inter, system-ui, Arial, sans-serif; }
.player-img-wrap { width: 100%; display: flex; justify-content: center; margin-bottom: 10px; }
.player-img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; box-shadow: 0 3px 10px rgba(0,0,0,.15); }

.player-card-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
.player-name { font-weight: 700; font-size: 15px; color: #0b1a49; }
.player-team { font-size: 12px; color: #667; }
.player-rank { font-weight: 700; font-size: 14px; color: #b8860b; }

.player-points { font-size: 13px; color: #222; margin-bottom: 4px; }
.player-ga { font-size: 12px; color: #555; margin-bottom: 8px; }
.bar-row { font-size: 11px; margin-bottom: 4px; }
.bar-label { display: flex; justify-content: space-between; margin-bottom: 2px; }
.bar-track { width: 100%; height: 6px; border-radius: 999px; background: #e3e7f3; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 999px; background: #101b40; }

/* Tabell */
.table-container { background: #fff; border-radius: 12px; overflow-x: auto; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
.table-container table { width: 100%; border-collapse: separate; border-spacing: 0; font: 15px/1.4 Inter, system-ui, Arial, sans-serif; }
.table-container thead th { position: sticky; top: 0; background: #101b40; color: #d6b15f; padding: 12px 10px; border-bottom: 1px solid #1f2a44; text-align: left; cursor: pointer; user-select: none; }
.table-container thead th:hover { background: #15255f; }
.table-container tbody td { padding: 12px 10px; border-bottom: 1px solid #e9eef5; text-align: left; }
.table-container tbody tr:hover { background: #f5f7ff; cursor: pointer; transition: background .2s; }

.lastUpdated { font-size: 13px; color: #666; margin-top: 8px; text-align: right; }

/* Mobil */
@media (max-width: 700px) {
  .header-box { flex-direction: column; align-items: flex-start; width: 100%; }
  .header-box input[type="text"] { width: 100%; }
  .table-container thead { display: none; }
  .table-container table, .table-container tbody, .table-container tr, .table-container td { display: block; width: 100%; }
  .table-container tbody tr { background: #fff; border: 1px solid #e0e4ee; border-radius: 12px; margin-bottom: 14px; padding: 10px 12px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
  .table-container tbody td { padding: 6px 4px; border: none; }
  .table-container tbody td:first-child { font-size: 17px; font-weight: 700; color: #0b1a49; margin-bottom: 6px; }
  .table-container tbody td::before { content: attr(data-label); font-weight: 600; color: #1f2a44; display: block; font-size: 13px; margin-bottom: 2px; }
}
</style>

<!-- üîπ SCRIPT -->
<script>
(function(){

  const SHEET_ID = "1toag5J7vMW0CEmtsrqByPJMJn6e-U5hOzZaKWoXnpxY";
  const DEFAULT_IMG = "https://drive.google.com/uc?export=view&id=1VAa79pJ-QbyeliY60autf914z6SBwmhp";

  function sheetCSV(name){
    return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(name)}`;
  }

  const SHEETS = {
    cards: sheetCSV("Spelarkort"),
    elite: sheetCSV("Elitepo√§ngliga"),
    pro: sheetCSV("Propo√§ngliga"),
    lite: sheetCSV("Litepo√§ngliga"),
    core: sheetCSV("Corepo√§ngliga"),
    neo: sheetCSV("Neopo√§ngliga")
  };

  const CONFIG = {
    elite: { name:"Elite", url:SHEETS.elite, searchId:"search-elite", topId:"top3-elite", tableId:"table-elite", updatedId:"updated-elite" },
    pro:   { name:"Pro", url:SHEETS.pro, searchId:"search-pro", topId:"top3-pro", tableId:"table-pro", updatedId:"updated-pro" },
    lite:  { name:"Lite", url:SHEETS.lite, searchId:"search-lite", topId:"top3-lite", tableId:"table-lite", updatedId:"updated-lite" },
    core:  { name:"Core", url:SHEETS.core, searchId:"search-core", topId:"top3-core", tableId:"table-core", updatedId:"updated-core" },
    neo:   { name:"Neo", url:SHEETS.neo, searchId:"search-neo", topId:"top3-neo", tableId:"table-neo", updatedId:"updated-neo" }
  };

  let loaded = {};
  let playerImgMap = null;

  /* ---- Robust CSV-parser ---- */
  function parseCSV(text){
    const rows=[]; let row=[]; let cur=""; let q=false;
    for(let i=0;i<text.length;i++){
      const c=text[i];
      if(c=='"' && text[i+1]=='"'){ cur+='"'; i++; continue; }
      if(c=='"'){ q=!q; continue; }
      if(c==',' && !q){ row.push(cur.trim()); cur=""; continue; }
      if((c=='\n' || c=='\r') && !q){
        if(cur.length||row.length){ row.push(cur.trim()); rows.push(row); row=[]; cur=""; }
        continue;
      }
      cur+=c;
    }
    if(cur.length||row.length){ row.push(cur.trim()); rows.push(row); }
    return rows.filter(r=>r.some(x=>x!==""));
  }

  /* ---- LADDA SPELARKORT BILDER ---- */
  function loadPlayerImages(){
    if(playerImgMap) return Promise.resolve(playerImgMap);

    return fetch(SHEETS.cards)
      .then(r=>r.text())
      .then(csv=>{
        const rows=parseCSV(csv);
        rows.shift();
        const map={};

        rows.forEach(r=>{
          const psn=(r[0]||"").trim().toLowerCase();
          const link=(r[1]||"");
          const id=(r[2]||"");
          let url="";

          if(id){
            url=`https://drive.google.com/uc?export=view&id=${id}`;
          } else if(link.includes("/d/")){
            const m=link.match(/\/d\/(.*?)\//);
            if(m && m[1]) url=`https://drive.google.com/uc?export=view&id=${m[1]}`;
          }
          if(psn && url) map[psn]=url;
        });

        playerImgMap=map;
        return map;
      })
      .catch(()=>{
        playerImgMap={};
        return {};
      });
  }

  /* ---- LADDA DIVISION ---- */
  function loadDivision(key){
    const cfg=CONFIG[key];
    if(loaded[key]) return;
    loaded[key]=true;

    const tableHost=document.getElementById(cfg.tableId);
    const topHost=document.getElementById(cfg.topId);
    const updated=document.getElementById(cfg.updatedId);
    const search=document.getElementById(cfg.searchId);

    tableHost.innerHTML="<div style='padding:12px'>Laddar statistik‚Ä¶</div>";

    loadPlayerImages().then(imgMap=>{
      fetch(cfg.url)
        .then(r=>r.text())
        .then(csv=>{
          const rows=parseCSV(csv);
          const header=rows.shift();

          const data=rows.map(r=>{
            const psn=(r[0]||"").trim();
            const key=psn.toLowerCase();               // <-- BILDMATCHNING FIX
            const img=imgMap[key] || DEFAULT_IMG;      // <-- DEFAULT BILD

            return {
              psn,
              team:r[1]||"",
              games:Number(r[2]||0),
              goals:Number(r[3]||0),
              assists:Number(r[4]||0),
              points:Number(r[5]||0),
              img
            };
          });

          // maxv√§rden
          let maxG=0, maxA=0, maxP=0;
          data.forEach(p=>{
            if(p.goals>maxG) maxG=p.goals;
            if(p.assists>maxA) maxA=p.assists;
            if(p.points>maxP) maxP=p.points;
          });

          // sortering
          data.sort((a,b)=>{
            if(b.points!==a.points) return b.points-a.points;
            if(b.goals!==a.goals) return b.goals-a.goals;
            return a.psn.localeCompare(b.psn);
          });

          renderTop3(topHost,data,maxG,maxA,maxP);
          renderTable(tableHost,data,header,search);

          updated.textContent="Senast uppdaterad: "+new Date().toLocaleString("sv-SE",{hour:"2-digit",minute:"2-digit",day:"numeric",month:"short",year:"numeric"});
        });
    });
  }

  /* ---- TOP 3 ---- */
  function renderTop3(host,data,maxG,maxA,maxP){
    const top=data.slice(0,3);
    host.innerHTML = top.map((p,i)=>`
      <div class="player-card">
        <div class="player-img-wrap">
          <img class="player-img" src="${p.img}" onerror="this.src='${DEFAULT_IMG}'">
        </div>
        <div class="player-card-header">
          <div>
            <div class="player-name">${p.psn}</div>
            <div class="player-team">${p.team}</div>
          </div>
          <div class="player-rank">#${i+1}</div>
        </div>
        <div class="player-points">${p.points} po√§ng</div>
        <div class="player-ga">G ${p.goals} ‚Ä¢ A ${p.assists} ‚Ä¢ GP ${p.games}</div>

        <div class="bar-row">
          <div class="bar-label"><span>M√•l</span><span>${p.goals}</span></div>
          <div class="bar-track"><div class="bar-fill" style="width:${maxG?(p.goals/maxG*100):0}%"></div></div>
        </div>
        <div class="bar-row">
          <div class="bar-label"><span>Assists</span><span>${p.assists}</span></div>
          <div class="bar-track"><div class="bar-fill" style="width:${maxA?(p.assists/maxA*100):0}%"></div></div>
        </div>
        <div class="bar-row">
          <div class="bar-label"><span>Po√§ng</span><span>${p.points}</span></div>
          <div class="bar-track"><div class="bar-fill" style="width:${maxP?(p.points/maxP*100):0}%"></div></div>
        </div>
      </div>
    `).join("");
  }

  /* ---- TABELL ---- */
  function renderTable(host,data,header,search){
    host.innerHTML = `
      <table>
        <thead><tr>${header.map(h=>`<th>${h}</th>`).join("")}</tr></thead>
        <tbody>
          ${data.map(p=>`
            <tr>
              <td>${p.psn}</td>
              <td>${p.team}</td>
              <td>${p.games}</td>
              <td>${p.goals}</td>
              <td>${p.assists}</td>
              <td>${p.points}</td>
            </tr>`).join("")}
        </tbody>
      </table>
    `;

    const tbody = host.querySelector("tbody");

    search.addEventListener("input", function(){
      const q=this.value.toLowerCase();
      [...tbody.rows].forEach(tr=>{
        const ok=[...tr.cells].some(td=>td.textContent.toLowerCase().includes(q));
        tr.style.display=ok?"":"none";
      });
    });
  }

  /* ---- TABS ---- */
  document.querySelectorAll(".ecl-tab").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const key=btn.dataset.division;

      document.querySelectorAll(".ecl-tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");

      document.querySelectorAll(".division").forEach(d=>d.classList.remove("active"));
      document.getElementById("division-"+key).classList.add("active");

      loadDivision(key);
    });
  });

  loadDivision("elite");

})();
</script>
