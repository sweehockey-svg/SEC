<!-- TABS -->
<div class="ecl-tabs">
  <button class="ecl-tab active" data-division="elite">Elite</button>
  <button class="ecl-tab" data-division="pro">Pro</button>
  <button class="ecl-tab" data-division="lite">Lite</button>
  <button class="ecl-tab" data-division="core">Core</button>
  <button class="ecl-tab" data-division="neo">Neo</button>
</div>

<!-- DIVISION WRAPPERS -->
<div id="division-elite" class="division active">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Elite Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-elite" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-elite" class="top3-container"></div>
  <div id="table-elite" class="table-container"></div>
  <p id="updated-elite" class="lastUpdated"></p>
</div>

<div id="division-pro" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Pro Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-pro" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-pro" class="top3-container"></div>
  <div id="table-pro" class="table-container"></div>
  <p id="updated-pro" class="lastUpdated"></p>
</div>

<div id="division-lite" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Lite Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-lite" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-lite" class="top3-container"></div>
  <div id="table-lite" class="table-container"></div>
  <p id="updated-lite" class="lastUpdated"></p>
</div>

<div id="division-core" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Core Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-core" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-core" class="top3-container"></div>
  <div id="table-core" class="table-container"></div>
  <p id="updated-core" class="lastUpdated"></p>
</div>

<div id="division-neo" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Neo Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-neo" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-neo" class="top3-container"></div>
  <div id="table-neo" class="table-container"></div>
  <p id="updated-neo" class="lastUpdated"></p>
</div>

<!-- STYLES -->
<style>
/* (EXAKT SOM DIN TIDIGARE ‚Äì INGEN √ÑNDRING BEH√ñVS, S√Ö JAG KORTAR NER DET H√ÑR)
   Jag inkluderar hela om du vill, men sparar plats.  
   S√§ker att du redan har det och inget i CSS beh√∂vde √§ndras f√∂r default-bilden. */
</style>

<!-- SCRIPT -->
<script>
(function(){

  const SHEET_ID = "1toag5J7vMW0CEmtsrqByPJMJn6e-U5hOzZaKWoXnpxY";

  function sheetCSV(sheetName) {
    return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }

  const SHEETS = {
    cards: sheetCSV("Spelarkort"),
    elite: sheetCSV("Elitepo√§ngliga"),
    pro:   sheetCSV("Propo√§ngliga"),
    lite:  sheetCSV("Litepo√§ngliga"),
    core:  sheetCSV("Corepo√§ngliga"),
    neo:   sheetCSV("Neopo√§ngliga")
  };

  const DEFAULT_IMG =
    "https://drive.google.com/uc?export=view&id=1VAa79pJ-QbyeliY60autf914z6SBwmhp";

  let loaded = {};
  let playerImgMap = null;

  /* ------------------ NORMALISERING ------------------ */
  function normalizeName(str) {
    if (!str) return "";
    return str
      .normalize("NFKD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[\u2000-\u200D\u00A0]/g, " ")
      .replace(/[^\w\s]/g, "")
      .replace(/\s+/g, " ")
      .trim()
      .toLowerCase();
  }

  /* ------------------ CSV-PARSER ------------------ */
  function parseCSV(csv) {
    const rows = [];
    let row = [];
    let cell = "";
    let inside = false;

    for (let i = 0; i < csv.length; i++) {
      const c = csv[i];

      if (c === '"' && csv[i+1] === '"') { cell += '"'; i++; continue; }
      if (c === '"') { inside = !inside; continue; }
      if (c === ',' && !inside) { row.push(cell.trim()); cell=""; continue; }
      if ((c === '\n' || c === '\r') && !inside) {
        if (cell.length || row.length) {
          row.push(cell.trim());
          rows.push(row);
        }
        row = []; cell = "";
        continue;
      }
      cell += c;
    }

    if (cell.length || row.length) {
      row.push(cell.trim());
      rows.push(row);
    }

    return rows.filter(r => r.some(x => x !== ""));
  }

  /* ------------------ LADDA SPELARBILDER ------------------ */
  function loadPlayerImages() {
    if (playerImgMap) return Promise.resolve(playerImgMap);

    return fetch(SHEETS.cards)
      .then(r => r.text())
      .then(csv => {
        const rows = parseCSV(csv);
        rows.shift();

        const map = {};

        rows.forEach(r => {
          const name = normalizeName(r[0] || "");
          const id = r[2] || "";
          let url = DEFAULT_IMG;

          if (id) {
            url = `https://drive.google.com/uc?export=view&id=${id}`;
          }

          if (name) map[name] = url;
        });

        playerImgMap = map;
        return map;
      })
      .catch(() => (playerImgMap = {}));
  }

  /* ------------------ LADDA DIVISION ------------------ */
  function loadDivision(key) {
    if (loaded[key]) return;
    loaded[key] = true;

    const cfgMap = {
      elite: ["top3-elite", "table-elite", "updated-elite", SHEETS.elite, "search-elite"],
      pro:   ["top3-pro",   "table-pro",   "updated-pro",   SHEETS.pro,   "search-pro"],
      lite:  ["top3-lite",  "table-lite",  "updated-lite",  SHEETS.lite,  "search-lite"],
      core:  ["top3-core",  "table-core",  "updated-core",  SHEETS.core,  "search-core"],
      neo:   ["top3-neo",   "table-neo",   "updated-neo",   SHEETS.neo,   "search-neo"]
    };

    const [topID, tableID, updID, url, searchID] = cfgMap[key];
    const topHost = document.getElementById(topID);
    const tableHost = document.getElementById(tableID);
    const updatedEl = document.getElementById(updID);
    const searchEl  = document.getElementById(searchID);

    loadPlayerImages().then(imgMap => {
      fetch(url)
        .then(r => r.text())
        .then(csv => {
          const rows = parseCSV(csv);
          const header = rows.shift();

          const data = rows.map(r => {
            const psn = r[0];
            const imgKey = normalizeName(psn);
            return {
              psn,
              team: r[1],
              games: Number(r[2] || 0),
              goals: Number(r[3] || 0),
              assists: Number(r[4] || 0),
              points: Number(r[5] || 0),
              img: imgMap[imgKey] || DEFAULT_IMG
            };
          });

          /* sortera */
          data.sort((a,b)=>
            b.points - a.points ||
            b.goals  - a.goals  ||
            a.psn.localeCompare(b.psn)
          );

          const maxG = Math.max(...data.map(p=>p.goals));
          const maxA = Math.max(...data.map(p=>p.assists));
          const maxP = Math.max(...data.map(p=>p.points));

          renderTop3(data.slice(0,3), topHost, maxG, maxA, maxP);
          renderTable(data, header, tableHost, searchEl);

          updatedEl.textContent =
            "Senast uppdaterad: " + new Date().toLocaleString("sv-SE");
        });
    });
  }

  /* ------------------ RENDER TOP 3 ------------------ */
  function renderTop3(list, host, maxG, maxA, maxP) {
    host.innerHTML = list.map((p,i)=>`
      <div class="player-card">
        <div class="player-img-wrap">
          <img class="player-img" src="${p.img}">
        </div>
        <div class="player-card-header">
          <div>
            <div class="player-name">${p.psn}</div>
            <div class="player-team">${p.team}</div>
          </div>
          <div class="player-rank">#${i+1}</div>
        </div>
        <div class="player-points">${p.points} po√§ng</div>
        <div class="player-ga">G ${p.goals} ‚Ä¢ A ${p.assists} ‚Ä¢ GP ${p.games}</div>

        ${renderBar("M√•l", p.goals, maxG)}
        ${renderBar("Assists", p.assists, maxA)}
        ${renderBar("Po√§ng", p.points, maxP)}
      </div>
    `).join("");
  }

  function renderBar(label, val, max) {
    return `
      <div class="bar-row">
        <div class="bar-label"><span>${label}</span><span>${val}</span></div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${max ? (val/max*100) : 0}%"></div>
        </div>
      </div>
    `;
  }

  /* ------------------ RENDER TABLE ------------------ */
  function renderTable(data, header, host, searchEl) {
    host.innerHTML = `
      <table>
        <thead>
          <tr>${header.map(h=>`<th>${h}</th>`).join("")}</tr>
        </thead>
        <tbody>
          ${data.map(p=>`
            <tr>
              <td>${p.psn}</td>
              <td>${p.team}</td>
              <td>${p.games}</td>
              <td>${p.goals}</td>
              <td>${p.assists}</td>
              <td>${p.points}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    if (searchEl) {
      searchEl.addEventListener("input",()=>{
        const q = searchEl.value.toLowerCase();
        host.querySelectorAll("tbody tr").forEach(tr=>{
          const show = [...tr.cells].some(td=>
            td.textContent.toLowerCase().includes(q)
          );
          tr.style.display = show ? "" : "none";
        });
      });
    }
  }

  /* ------------------ TAB CLICK ------------------ */
  document.querySelectorAll(".ecl-tab").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const key = btn.dataset.division;

      document.querySelectorAll(".ecl-tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");

      document.querySelectorAll(".division").forEach(d=>d.classList.remove("active"));
      document.getElementById("division-"+key).classList.add("active");

      loadDivision(key);
    });
  });

  /* Ladda Elite direkt */
  loadDivision("elite");

})();
</script>
