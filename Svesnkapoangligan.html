<script>
(function(){
  const SHEET_ID = "1toag5J7vMW0CEmtsrqByPJMJn6e-U5hOzZaKWoXnpxY";

  function sheetCSV(sheetName) {
    return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }

  const SHEETS = {
    cards: sheetCSV("Spelarkort"),
    elite: sheetCSV("Elitepoängliga"),
    pro:   sheetCSV("Propoängliga"),
    lite:  sheetCSV("Litepoängliga"),
    core:  sheetCSV("Corepoängliga"),
    neo:   sheetCSV("Neopoängliga")
  };

  const CONFIG = {
    elite: { name: "Elite", url: SHEETS.elite, searchId: "search-elite", topId: "top3-elite", tableId: "table-elite", updatedId: "updated-elite" },
    pro:   { name: "Pro",   url: SHEETS.pro,   searchId: "search-pro",   topId: "top3-pro",   tableId: "table-pro",   updatedId: "updated-pro" },
    lite:  { name: "Lite",  url: SHEETS.lite,  searchId: "search-lite",  topId: "top3-lite",  tableId: "table-lite",  updatedId: "updated-lite" },
    core:  { name: "Core",  url: SHEETS.core,  searchId: "search-core",  topId: "top3-core",  tableId: "table-core",  updatedId: "updated-core" },
    neo:   { name: "Neo",   url: SHEETS.neo,   searchId: "search-neo",   topId: "top3-neo",   tableId: "table-neo",   updatedId: "updated-neo" }
  };

  const DEFAULT_IMG = "https://drive.google.com/uc?export=view&id=1VAa79pJ-QbyeliY60autf914z6SBwmhp";

  const loaded = {};
  let playerImgMap = null;
  let playerImgPromise = null;

  /* ---------- CSV-PARSER ---------- */
  function parseCSV(csv) {
    const rows = [];
    let row = [];
    let current = "";
    let insideQuotes = false;

    for (let i = 0; i < csv.length; i++) {
      const c = csv[i];

      if (c === '"' && csv[i+1] === '"') {
        current += '"';
        i++;
        continue;
      }
      if (c === '"') {
        insideQuotes = !insideQuotes;
        continue;
      }
      if (c === ',' && !insideQuotes) {
        row.push(current.trim());
        current = "";
        continue;
      }
      if ((c === '\n' || c === '\r') && !insideQuotes) {
        if (current.length || row.length) {
          row.push(current.trim());
          current = "";
          rows.push(row);
          row = [];
        }
        continue;
      }
      current += c;
    }

    if (current.length || row.length) {
      row.push(current.trim());
      rows.push(row);
    }

    return rows.filter(r => r.some(cell => cell !== ""));
  }

  /* ---------- LADDA SPELARBILDER ---------- */
  function ensurePlayerImagesLoaded() {
    if (playerImgMap) return Promise.resolve(playerImgMap);
    if (playerImgPromise) return playerImgPromise;

    playerImgPromise = fetch(SHEETS.cards)
      .then(r => r.text())
      .then(csv => {
        const rows = parseCSV(csv);
        rows.shift(); // Header

        const map = {};

        rows.forEach(r => {
          const key = (r[0] || "").trim().toLowerCase(); // PSN som "laxenhd"
          const driveLink = (r[1] || "").trim();
          const driveId = (r[2] || "").trim();

          let url = "";

          if (driveId) {
            url = `https://drive.google.com/uc?export=view&id=${driveId}`;
          } else if (driveLink.includes("/d/")) {
            const m = driveLink.match(/\/d\/(.*?)\//);
            if (m && m[1]) url = `https://drive.google.com/uc?export=view&id=${m[1]}`;
          }

          if (key && url) map[key] = url;
        });

        playerImgMap = map;
        return map;
      })
      .catch(err => {
        console.error("Kunde inte ladda Spelarkort:", err);
        playerImgMap = {};
        return playerImgMap;
      });

    return playerImgPromise;
  }

  /* ---------- LADDA DIVISION ---------- */
  function loadDivision(key) {
    const cfg = CONFIG[key];
    if (!cfg) return;
    if (loaded[key]) return;
    loaded[key] = true;

    const tableHost = document.getElementById(cfg.tableId);
    const topHost   = document.getElementById(cfg.topId);
    const updatedEl = document.getElementById(cfg.updatedId);
    const searchEl  = document.getElementById(cfg.searchId);

    tableHost.innerHTML = '<div style="padding:12px;font-family:system-ui,Arial">Laddar statistik …</div>';

    ensurePlayerImagesLoaded().then(imgMap => {
      fetch(cfg.url)
        .then(r => r.text())
        .then(csv => {
          const rows = parseCSV(csv);
          const header = rows.shift();

          const data = rows.map(r => {
            const psn = (r[0] || "").trim();
            const imgKey = psn.toLowerCase(); // ENDA MATCHNINGEN
            const team = r[1] || "";
            const games = Number(r[2] || 0);
            const goals = Number(r[3] || 0);
            const assists = Number(r[4] || 0);
            const points = Number(r[5] || 0);
            const img = imgMap[imgKey] || DEFAULT_IMG;

            return { psn, team, games, goals, assists, points, img };
          });

          let maxG = 0, maxA = 0, maxP = 0;
          data.forEach(p => {
            if (p.goals   > maxG) maxG = p.goals;
            if (p.assists > maxA) maxA = p.assists;
            if (p.points  > maxP) maxP = p.points;
          });

          data.sort((a,b) => {
            if (b.points !== a.points) return b.points - a.points;
            if (b.goals  !== a.goals)  return b.goals - a.goals;
            return a.psn.localeCompare(b.psn);
          });

          renderTop3(data, topHost, maxG, maxA, maxP);
          renderTable(data, header, tableHost, searchEl);

          if (updatedEl) {
            updatedEl.textContent = "Senast uppdaterad: " + new Date().toLocaleString("sv-SE", {
              day: "numeric", month: "short", year: "numeric",
              hour: "2-digit", minute: "2-digit"
            });
          }
        });
    });
  }

  /* ---------- TOP 3 ---------- */
  function renderTop3(data, host, maxG, maxA, maxP) {
    if (!host) return;

    const top3 = data.slice(0, 3);

    host.innerHTML = top3.map((p, idx) => `
      <div class="player-card">
        <div class="player-img-wrap">
          <img class="player-img" src="${p.img}" alt="${p.psn}">
        </div>
        <div class="player-card-header">
          <div>
            <div class="player-name">${p.psn}</div>
            <div class="player-team">${p.team}</div>
          </div>
          <div class="player-rank">#${idx + 1}</div>
        </div>
        <div class="player-points">${p.points} poäng</div>
        <div class="player-ga">G ${p.goals} • A ${p.assists} • GP ${p.games}</div>

        <div class="bar-row">
          <div class="bar-label"><span>Mål</span><span>${p.goals}</span></div>
          <div class="bar-track"><div class="bar-fill" style="width:${(p.goals / maxG) * 100}%"></div></div>
        </div>

        <div class="bar-row">
          <div class="bar-label"><span>Assists</span><span>${p.assists}</span></div>
          <div class="bar-track"><div class="bar-fill" style="width:${(p.assists / maxA) * 100}%"></div></div>
        </div>

        <div class="bar-row">
          <div class="bar-label"><span>Poäng</span><span>${p.points}</span></div>
          <div class="bar-track"><div class="bar-fill" style="width:${(p.points / maxP) * 100}%"></div></div>
        </div>
      </div>
    `).join("");
  }

  /* ---------- TABELL ---------- */
  function renderTable(data, header, host, searchEl) {
    const html = `
      <table>
        <thead>
          <tr>${header.map(h => `<th>${h}</th>`).join("")}</tr>
        </thead>
        <tbody>
          ${data.map(p => `
            <tr>
              <td data-label="${header[0]}">${p.psn}</td>
              <td data-label="${header[1]}">${p.team}</td>
              <td data-label="${header[2]}">${p.games}</td>
              <td data-label="${header[3]}">${p.goals}</td>
              <td data-label="${header[4]}">${p.assists}</td>
              <td data-label="${header[5]}">${p.points}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    host.innerHTML = html;

    const table = host.querySelector("table");
    const tbody = table.querySelector("tbody");
    const thead = table.querySelector("thead");

    let asc = true;

    thead.querySelectorAll("th").forEach((th, idx) => {
      th.addEventListener("click", () => {
        const sorted = [...data].sort((a,b) => {
          const A = Object.values(a)[idx];
          const B = Object.values(b)[idx];
          const numA = Number(A), numB = Number(B);
          let res = (!isNaN(numA) && !isNaN(numB)) ? numA - numB : String(A).localeCompare(String(B));
          return asc ? res : -res;
        });
        asc = !asc;

        tbody.innerHTML = sorted.map(p => `
          <tr>
            <td>${p.psn}</td>
            <td>${p.team}</td>
            <td>${p.games}</td>
            <td>${p.goals}</td>
            <td>${p.assists}</td>
            <td>${p.points}</td>
          </tr>
        `).join("");
      });
    });

    if (searchEl) {
      searchEl.addEventListener("input", function() {
        const q = this.value.toLowerCase();
        [...tbody.rows].forEach(tr => {
          const match = [...tr.cells].some(td => td.textContent.toLowerCase().includes(q));
          tr.style.display = match ? "" : "none";
        });
      });
    }
  }

  /* ---------- TABS ---------- */
  document.querySelectorAll(".ecl-tab").forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.dataset.division;

      document.querySelectorAll(".ecl-tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      document.querySelectorAll(".division").forEach(div => div.classList.remove("active"));
      document.getElementById("division-" + key).classList.add("active");

      loadDivision(key);
    });
  });

  loadDivision("elite");

})();
</script>
