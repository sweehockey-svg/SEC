<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>ECL 26 Winter ‚Äì Svenska po√§ngligor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: Inter, system-ui, Arial, sans-serif;
      background: #ffffff;
    }

    /* TABS */
    .ecl-tabs {
      display: flex;
      gap: 6px;
      margin: 10px 0 16px;
      flex-wrap: wrap;
      padding: 0 8px;
    }
    .ecl-tab {
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      background: #f1f3fa;
      color: #202742;
      font-weight: 600;
    }
    .ecl-tab.active {
      background: #101b40;
      color: #f7e0a2;
    }

    .division { display: none; padding: 0 8px 20px; }
    .division.active { display: block; }

    .header-box {
      display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
      margin: 10px 0 20px; gap: 12px;
    }
    .header-box h2 {
      font-size: 24px; font-weight: 800; color: #0b1a49;
      margin: 0; text-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    .header-box input[type="text"] {
      padding: 10px 14px; font-size: 15px; border: 1px solid #ccc;
      border-radius: 10px; min-width: 240px; outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    /* TOP 3 cards */
    .top3-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 18px;
    }
    .player-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,.06);
    }
    .player-img-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .player-img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 3px 10px rgba(0,0,0,.15);
    }
    .player-card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }
    .player-name { font-weight: 700; font-size: 15px; color: #0b1a49; }
    .player-team { font-size: 12px; color: #667; }
    .player-rank { font-weight: 700; font-size: 14px; color: #b8860b; }
    .player-points { font-size: 13px; color: #222; margin-bottom: 4px; }
    .player-ga { font-size: 12px; color: #555; margin-bottom: 8px; }

    .bar-row { font-size: 11px; margin-bottom: 4px; }
    .bar-label { display: flex; justify-content: space-between; margin-bottom: 2px; }
    .bar-track {
      width: 100%; height: 6px; border-radius: 999px;
      background: #e3e7f3; overflow: hidden;
    }
    .bar-fill {
      height: 100%; border-radius: 999px; background: #101b40;
    }

    /* TABLE */
    .table-container {
      background: #fff; border-radius: 12px; overflow-x: auto;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .table-container table {
      width: 100%; border-collapse: separate; border-spacing: 0;
      font: 15px/1.4 Inter, system-ui, Arial, sans-serif;
    }
    .table-container thead th {
      position: sticky; top: 0; background: #101b40; color: #d6b15f;
      padding: 12px 10px; border-bottom: 1px solid #1f2a44;
      cursor: pointer; user-select: none;
    }
    .table-container tbody td {
      padding: 12px 10px; border-bottom: 1px solid #e9eef5;
    }
    .table-container tbody tr:hover {
      background: #f5f7ff; cursor: pointer;
    }

    .lastUpdated {
      font-size: 13px; color: #666; margin-top: 8px; text-align: right;
    }
  </style>
</head>
<body>

<!-- Tabs -->
<div class="ecl-tabs">
  <button class="ecl-tab active" data-division="elite">Elite</button>
  <button class="ecl-tab" data-division="pro">Pro</button>
  <button class="ecl-tab" data-division="lite">Lite</button>
  <button class="ecl-tab" data-division="core">Core</button>
  <button class="ecl-tab" data-division="neo">Neo</button>
</div>

<!-- Division containers -->
<div id="division-elite" class="division active">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Elite Po√§ngliga (Svenska spelare)</h2>
    <input id="search-elite" type="text" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-elite" class="top3-container"></div>
  <div id="table-elite" class="table-container"></div>
  <p id="updated-elite" class="lastUpdated"></p>
</div>

<div id="division-pro" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Pro Po√§ngliga (Svenska spelare)</h2>
    <input id="search-pro" type="text" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-pro" class="top3-container"></div>
  <div id="table-pro" class="table-container"></div>
  <p id="updated-pro" class="lastUpdated"></p>
</div>

<div id="division-lite" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Lite Po√§ngliga (Svenska spelare)</h2>
    <input id="search-lite" type="text" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-lite" class="top3-container"></div>
  <div id="table-lite" class="table-container"></div>
  <p id="updated-lite" class="lastUpdated"></p>
</div>

<div id="division-core" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Core Po√§ngliga (Svenska spelare)</h2>
    <input id="search-core" type="text" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-core" class="top3-container"></div>
  <div id="table-core" class="table-container"></div>
  <p id="updated-core" class="lastUpdated"></p>
</div>

<div id="division-neo" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Neo Po√§ngliga (Svenska spelare)</h2>
    <input id="search-neo" type="text" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-neo" class="top3-container"></div>
  <div id="table-neo" class="table-container"></div>
  <p id="updated-neo" class="lastUpdated"></p>
</div>

<script>
(function(){

  const TABLE_SHEET_ID = "1toag5J7vMW0CEmtsrqByPJMJn6e-U5hOzZaKWoXnpxY";

  const CARD_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSZCNO-QbbfniaDOODJpcE_B8ab6RHunhkSRGuEjYeVlM2TVq6okNMG8JPHHZyWf50RsJFflI6bbAnB/pub?gid=2047009971&single=true&output=csv";

  const DEFAULT_IMG = "https://drive.google.com/thumbnail?id=1VAa79pJ-QbyeliY60autf914z6SBwmhp&sz=w1000";


  function tableSheet(name){
    return `https://docs.google.com/spreadsheets/d/${TABLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(name)}`;
  }

  const SHEETS = {
    cards: CARD_CSV,
    elite: tableSheet("Elitepo√§ngliga"),
    pro:   tableSheet("Propo√§ngliga"),
    lite:  tableSheet("Litepo√§ngliga"),
    core:  tableSheet("Corepo√§ngliga"),
    neo:   tableSheet("Neopo√§ngliga")
  };

  /* CSV parser */
  function parseCSV(txt){
    const lines = [];
    let row = [];
    let cur = "";
    let q = false;
    for (let i=0;i<txt.length;i++){
      const c = txt[i];
      const nxt = txt[i+1];
      if (c === '"' && nxt === '"'){ cur += '"'; i++; continue; }
      if (c === '"'){ q = !q; continue; }
      if (c === ',' && !q){ row.push(cur); cur=""; continue; }
      if ((c === '\n' || c === '\r') && !q){
        if (cur.length || row.length){ row.push(cur); lines.push(row); row=[]; cur=""; }
        continue;
      }
      cur+=c;
    }
    if (cur.length || row.length){ row.push(cur); lines.push(row); }
    return lines.filter(r=>r.some(x=>x.trim()!==""));
  }

  function normalize(str){
    if (!str) return "";
    return str.normalize("NFKD")
      .replace(/[\u0300-\u036f]/g,"")
      .replace(/[^\w\s]/g,"")
      .replace(/\s+/g," ")
      .trim()
      .toLowerCase();
  }

  /* Ladda ID -> DRIVE-bilder */
  let cardMap = null;
  let loadCardPromise = null;

  function loadCardImages(){
    if (cardMap) return Promise.resolve(cardMap);
    if (loadCardPromise) return loadCardPromise;

    loadCardPromise = fetch(SHEETS.cards)
      .then(r=>r.text())
      .then(csv=>{
        const rows = parseCSV(csv);
        rows.shift();

        const map={};

        rows.forEach(r=>{
          const name = normalize(r[0]||"");       // A = spelarnamn
          const driveId = (r[1]||"").trim();      // B = DRIVE-ID (DIN BEKR√ÑFTADE KOLUMN)
          let url = DEFAULT_IMG;

          if (driveId){
            url = `https://drive.google.com/thumbnail?id=${driveId}&sz=w1000`;
          }

          map[name] = url;
        });

        cardMap = map;
        return map;
      });

    return loadCardPromise;
  }

  /* Ladda DIVISION */
  const loaded = {};

  function loadDivision(div){
    if (loaded[div]) return;
    loaded[div]=true;

    const cfg = {
      elite:{url:SHEETS.elite,search:"search-elite",top:"top3-elite",table:"table-elite",updated:"updated-elite"},
      pro:{url:SHEETS.pro,search:"search-pro",top:"top3-pro",table:"table-pro",updated:"updated-pro"},
      lite:{url:SHEETS.lite,search:"search-lite",top:"top3-lite",table:"table-lite",updated:"updated-lite"},
      core:{url:SHEETS.core,search:"search-core",top:"top3-core",table:"table-core",updated:"updated-core"},
      neo:{url:SHEETS.neo,search:"search-neo",top:"top3-neo",table:"table-neo",updated:"updated-neo"}
    }[div];

    const tbl = document.getElementById(cfg.table);
    const top = document.getElementById(cfg.top);
    const upd = document.getElementById(cfg.updated);
    const search = document.getElementById(cfg.search);

    tbl.innerHTML = "<div style='padding:12px'>Laddar...</div>";

    loadCardImages().then(map=>{
      fetch(cfg.url)
        .then(r=>r.text())
        .then(csv=>{
          const rows = parseCSV(csv);
          const header = rows.shift();

          let data = rows.map(r=>{
            const psn = (r[0]||"").trim();
            const key = normalize(psn);
            const img = map[key] || DEFAULT_IMG;

            return {
              psn,
              team:(r[1]||""),
              games:Number(r[2]||0),
              goals:Number(r[3]||0),
              assists:Number(r[4]||0),
              points:Number(r[5]||0),
              img
            };
          });

          const maxG = Math.max(...data.map(x=>x.goals));
          const maxA = Math.max(...data.map(x=>x.assists));
          const maxP = Math.max(...data.map(x=>x.points));

          data.sort((a,b)=>{
            if (b.points !== a.points) return b.points-a.points;
            if (b.goals !== a.goals) return b.goals-a.goals;
            return a.psn.localeCompare(b.psn);
          });

          /* TOP 3 */
          top.innerHTML = data.slice(0,3).map((p,i)=>`
            <div class="player-card">
              <div class="player-img-wrap">
                <img class="player-img" src="${p.img}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'">
              </div>
              <div class="player-card-header">
                <div>
                  <div class="player-name">${p.psn}</div>
                  <div class="player-team">${p.team}</div>
                </div>
                <div class="player-rank">#${i+1}</div>
              </div>
              <div class="player-points">${p.points} po√§ng</div>
              <div class="player-ga">G ${p.goals} ‚Ä¢ A ${p.assists} ‚Ä¢ GP ${p.games}</div>

              <div class="bar-row">
                <div class="bar-label"><span>M√•l</span><span>${p.goals}</span></div>
                <div class="bar-track"><div class="bar-fill" style="width:${(p.goals/maxG*100)||0}%"></div></div>
              </div>
              <div class="bar-row">
                <div class="bar-label"><span>Assists</span><span>${p.assists}</span></div>
                <div class="bar-track"><div class="bar-fill" style="width:${(p.assists/maxA*100)||0}%"></div></div>
              </div>
              <div class="bar-row">
                <div class="bar-label"><span>Po√§ng</span><span>${p.points}</span></div>
                <div class="bar-track"><div class="bar-fill" style="width:${(p.points/maxP*100)||0}%"></div></div>
              </div>
            </div>
          `).join("");

          /* TABELL */
          tbl.innerHTML = `
            <table>
              <thead><tr>${header.map(h=>`<th>${h}</th>`).join("")}</tr></thead>
              <tbody>
                ${data.map(p=>`
                <tr>
                  <td>${p.psn}</td>
                  <td>${p.team}</td>
                  <td>${p.games}</td>
                  <td>${p.goals}</td>
                  <td>${p.assists}</td>
                  <td>${p.points}</td>
                </tr>`).join("")}
              </tbody>
            </table>
          `;

          upd.textContent =
            "Senast uppdaterad: " +
            new Date().toLocaleString("sv-SE",{hour:"2-digit",minute:"2-digit",day:"numeric",month:"short"});

          /* S√∂k */
          search.addEventListener("input",()=>{
            const q = search.value.toLowerCase();
            tbl.querySelectorAll("tbody tr").forEach(tr=>{
              tr.style.display = tr.innerText.toLowerCase().includes(q) ? "" : "none";
            });
          });

        });
    });
  }

  /* Tabs */
  document.querySelectorAll(".ecl-tab").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".ecl-tab").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");

      document.querySelectorAll(".division").forEach(x=>x.classList.remove("active"));
      document.getElementById("division-"+btn.dataset.division).classList.add("active");

      loadDivision(btn.dataset.division);
    });
  });

  loadDivision("elite");

})();
</script>

</body>
</html>
