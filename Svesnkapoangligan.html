<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Svenska Po√§ngligan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* --- TABS --- */
.ecl-tabs {
  display: flex;
  gap: 6px;
  margin: 10px 0 16px;
  flex-wrap: wrap;
}
.ecl-tab {
  border: none;
  padding: 8px 14px;
  border-radius: 999px;
  font-family: Inter, system-ui, Arial, sans-serif;
  font-size: 14px;
  cursor: pointer;
  background: #f1f3fa;
  color: #202742;
  font-weight: 600;
}
.ecl-tab.active {
  background: #101b40;
  color: #f7e0a2;
}

.division { display: none; }
.division.active { display: block; }

/* HEADER */
.header-box {
  display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
  margin: 10px 0 20px; gap: 12px;
}
.header-box h2 {
  font-family: Inter, system-ui, Arial, sans-serif;
  font-size: 24px; font-weight: 800; color: #0b1a49;
  margin: 0; text-shadow: 0 2px 6px rgba(0,0,0,.08);
}
.header-box input[type="text"] {
  padding: 10px 14px; font-size: 15px; border: 1px solid #ccc;
  border-radius: 10px; min-width: 240px; outline: none;
  transition: border-color .2s, box-shadow .2s;
}
.header-box input[type="text"]:focus {
  border-color: #0b1a49; box-shadow: 0 0 0 2px rgba(11,26,73,.15);
}

/* TOP3 LAYOUT */
.top3-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 16px;
  margin-bottom: 18px;
}

.player-card {
  background: #ffffff;
  border-radius: 16px;
  padding: 14px 16px;
  box-shadow: 0 4px 16px rgba(0,0,0,.06);
  font-family: Inter, system-ui, Arial, sans-serif;
}

.player-img-wrap {
  width: 100%;
  display: flex;
  justify-content: center;
  margin-bottom: 10px;
}

.player-img {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  object-fit: cover;
  box-shadow: 0 3px 10px rgba(0,0,0,.15);
}

.player-card-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 6px;
}

.player-name { font-weight: 700; font-size: 15px; color: #0b1a49; }
.player-team { font-size: 12px; color: #667; }
.player-rank { font-weight: 700; font-size: 14px; color: #b8860b; }

/* TABLE */
.table-container {
  background: #fff; border-radius: 12px; overflow-x: auto;
  box-shadow: 0 6px 18px rgba(0,0,0,.08);
}
.table-container table {
  width: 100%; border-collapse: separate; border-spacing: 0;
  font: 15px/1.4 Inter, system-ui, Arial, sans-serif;
}
.table-container thead th {
  position: sticky; top: 0; background: #101b40; color: #d6b15f;
  padding: 12px 10px; border-bottom: 1px solid #1f2a44;
  text-align: left; cursor: pointer; user-select: none;
  font-weight: 700; letter-spacing: .3px;
}
.table-container tbody td {
  padding: 12px 10px; border-bottom: 1px solid #e9eef5; text-align: left;
}
.table-container tbody tr:hover {
  background: #f5f7ff; cursor: pointer; transition: background .2s;
}

.lastUpdated { font-size: 13px; color: #666; margin-top: 8px; text-align: right; }

</style>
</head>
<body>

<!-- TABS -->
<div class="ecl-tabs">
  <button class="ecl-tab active" data-division="elite">Elite</button>
  <button class="ecl-tab" data-division="pro">Pro</button>
  <button class="ecl-tab" data-division="lite">Lite</button>
  <button class="ecl-tab" data-division="core">Core</button>
  <button class="ecl-tab" data-division="neo">Neo</button>
</div>

<!-- DIVISIONS -->
<div id="division-elite" class="division active">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Elite Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-elite" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-elite" class="top3-container"></div>
  <div id="table-elite" class="table-container"></div>
  <p id="updated-elite" class="lastUpdated"></p>
</div>

<div id="division-pro" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Pro Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-pro" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-pro" class="top3-container"></div>
  <div id="table-pro" class="table-container"></div>
  <p id="updated-pro" class="lastUpdated"></p>
</div>

<div id="division-lite" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Lite Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-lite" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-lite" class="top3-container"></div>
  <div id="table-lite" class="table-container"></div>
  <p id="updated-lite" class="lastUpdated"></p>
</div>

<div id="division-core" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Core Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-core" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-core" class="top3-container"></div>
  <div id="table-core" class="table-container"></div>
  <p id="updated-core" class="lastUpdated"></p>
</div>

<div id="division-neo" class="division">
  <div class="header-box">
    <h2>üèÜ ECL 26 Winter ‚Äì Neo Po√§ngliga (Svenska spelare)</h2>
    <input type="text" id="search-neo" placeholder="üîç S√∂k spelare eller lag...">
  </div>
  <div id="top3-neo" class="top3-container"></div>
  <div id="table-neo" class="table-container"></div>
  <p id="updated-neo" class="lastUpdated"></p>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const SHEET_ID = "1toag5J7vMW0CEmtsrqByPJMJn6e-U5hOzZaKWoXnpxY";

function sheetCSV(sheetName) {
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
}

const SHEETS = {
  cards: sheetCSV("Spelarkort"),
  elite: sheetCSV("Elitepo√§ngliga"),
  pro:   sheetCSV("Propo√§ngliga"),
  lite:  sheetCSV("Litepo√§ngliga"),
  core:  sheetCSV("Corepo√§ngliga"),
  neo:   sheetCSV("Neopo√§ngliga")
};

const loaded = {};
let playerImgMap = null;
let playerImgPromise = null;

/* ---------------- HELPERS ---------------- */
function normalizeName(str) {
  return str
    .normalize("NFKD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^\w\s]/g, "")
    .replace(/\s+/g, " ")
    .trim()
    .toLowerCase();
}

function parseCSV(csv) {
  const rows = [];
  let row = [];
  let current = "";
  let inside = false;

  for (let i = 0; i < csv.length; i++) {
    const c = csv[i];

    if (c === '"' && csv[i+1] === '"') {
      current += '"';
      i++;
      continue;
    }
    if (c === '"') { inside = !inside; continue; }
    if (c === ',' && !inside) {
      row.push(current.trim());
      current = "";
      continue;
    }
    if ((c === '\n' || c === '\r') && !inside) {
      if (current.length || row.length) {
        row.push(current.trim());
        rows.push(row);
        row = [];
        current = "";
      }
      continue;
    }
    current += c;
  }
  if (current.length || row.length) {
    row.push(current.trim());
    rows.push(row);
  }
  return rows;
}

/* ---------------- LOAD PLAYER IMAGES ---------------- */
function ensurePlayerImagesLoaded() {
  if (playerImgMap) return Promise.resolve(playerImgMap);
  if (playerImgPromise) return playerImgPromise;

  playerImgPromise = fetch(SHEETS.cards)
    .then(r => r.text())
    .then(csv => {
      const rows = parseCSV(csv);
      rows.shift(); // header

      const map = {};

      rows.forEach(r => {
        const key = normalizeName(r[0] || "");
        const driveLink = (r[1] || "").trim();
        const driveId = (r[2] || "").trim();
        let url = "";

        if (driveId) {
          url = `https://drive.usercontent.google.com/download?id=${driveId}&export=view`;
        } else if (driveLink.includes("/d/")) {
          const m = driveLink.match(/\/d\/(.*?)\//);
          if (m && m[1]) {
            url = `https://drive.usercontent.google.com/download?id=${m[1]}&export=view`;
          }
        }
        if (key && url) map[key] = url;
      });

      playerImgMap = map;
      return map;
    })
    .catch(err => {
      console.error("Error loading images:", err);
      playerImgMap = {};
      return {};
    });

  return playerImgPromise;
}

/* ---------------- LOAD DIVISION ---------------- */
function loadDivision(name) {
  if (loaded[name]) return;
  loaded[name] = true;

  const cfg = {
    elite: { sheet: SHEETS.elite, top: "top3-elite", table: "table-elite", updated: "updated-elite", search: "search-elite" },
    pro:   { sheet: SHEETS.pro,   top: "top3-pro",   table: "table-pro",   updated: "updated-pro",   search: "search-pro" },
    lite:  { sheet: SHEETS.lite,  top: "top3-lite",  table: "table-lite",  updated: "updated-lite",  search: "search-lite" },
    core:  { sheet: SHEETS.core,  top: "top3-core",  table: "table-core",  updated: "updated-core",  search: "search-core" },
    neo:   { sheet: SHEETS.neo,   top: "top3-neo",   table: "table-neo",   updated: "updated-neo",   search: "search-neo" }
  }[name];

  const tableHost = document.getElementById(cfg.table);
  const topHost   = document.getElementById(cfg.top);
  const updatedEl = document.getElementById(cfg.updated);
  const searchEl  = document.getElementById(cfg.search);

  tableHost.innerHTML = "<p style='padding:10px'>Laddar‚Ä¶</p>";

  ensurePlayerImagesLoaded().then(imgMap => {
    fetch(cfg.sheet)
      .then(r => r.text())
      .then(csv => {
        const rows = parseCSV(csv);
        const header = rows.shift();

        const data = rows.map(r => {
          const psn = r[0];
          return {
            psn,
            team: r[1],
            games: Number(r[2]),
            goals: Number(r[3]),
            assists: Number(r[4]),
            points: Number(r[5]),
            img: imgMap[normalizeName(psn)] || "https://via.placeholder.com/120"
          };
        });

        data.sort((a,b) => b.points - a.points || b.goals - a.goals);

        renderTop3(data, topHost);
        renderTable(data, header, tableHost, searchEl);

        updatedEl.textContent =
          "Senast uppdaterad: " + new Date().toLocaleString("sv-SE");
      });
  });
}

/* ---------------- RENDER TOP3 ---------------- */
function renderTop3(data, host) {
  host.innerHTML = data.slice(0,3).map((p,i) => `
    <div class="player-card">
      <div class="player-img-wrap">
        <img class="player-img" src="${p.img}" alt="${p.psn}">
      </div>
      <div class="player-card-header">
        <div>
          <div class="player-name">${p.psn}</div>
          <div class="player-team">${p.team}</div>
        </div>
        <div class="player-rank">#${i+1}</div>
      </div>
      <div class="player-points">${p.points} po√§ng</div>
      <div class="player-ga">G ${p.goals} ‚Ä¢ A ${p.assists} ‚Ä¢ GP ${p.games}</div>
    </div>
  `).join("");
}

/* ---------------- RENDER TABLE ---------------- */
function renderTable(data, header, host, searchEl) {
  host.innerHTML = `
    <table>
      <thead><tr>${header.map(h => `<th>${h}</th>`).join("")}</tr></thead>
      <tbody>
        ${data.map(p => `
          <tr>
            <td>${p.psn}</td>
            <td>${p.team}</td>
            <td>${p.games}</td>
            <td>${p.goals}</td>
            <td>${p.assists}</td>
            <td>${p.points}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;

  if (searchEl) {
    searchEl.addEventListener("input", () => {
      const q = searchEl.value.toLowerCase();
      [...host.querySelector("tbody").rows].forEach(tr => {
        const show = [...tr.cells].some(td => td.textContent.toLowerCase().includes(q));
        tr.style.display = show ? "" : "none";
      });
    });
  }
}

/* ---------------- TABS ---------------- */
document.querySelectorAll(".ecl-tab").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".ecl-tab").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".division").forEach(d => d.classList.remove("active"));

    btn.classList.add("active");
    document.getElementById("division-" + btn.dataset.division).classList.add("active");

    loadDivision(btn.dataset.division);
  });
});

/* Load Elite first */
loadDivision("elite");
</script>

</body>
</html>
