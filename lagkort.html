<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Svenska eHockey Cupen ‚Äì Lag</title>

  <style>
    .roster-medal-text {
  margin-top: 4px;
  font-size: 0.75rem;
  color: #f9c45b; /* gul */
}
.roster-card {
  text-align: center;
}

.player-mini {
  width: 100px;
  height: 145px;
  border-radius: 14px;
  object-fit: cover;
  margin-bottom: 8px;
  border: 2px solid rgba(245,216,110,0.55);
  background: #050712;
  box-shadow: 0 0 12px rgba(245,216,110,0.15);
}


    .section-divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 35px 0 20px;
      color: #f5d86e;
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(245,216,110,0.3);
    }

    .section-divider::before,
    .section-divider::after {
      content: "";
      flex: 1;
      border-bottom: 1px solid rgba(245,216,110,0.35);
      margin: 0 14px;
    }

    /* Loader */
    .sec-loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0 4px;
    }
    .loader-text {
      font-size: 0.95rem;
      color: #f6d66b;
      margin-bottom: 8px;
      letter-spacing: .04em;
    }
    .loader-bar {
      width: 200px;
      height: 10px;
      background: rgba(255,255,255,0.08);
      border-radius: 6px;
      border: 1px solid rgba(246,214,107,0.35);
      overflow: hidden;
      margin: 0 auto;
    }
    .loader-bar-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #f6d66b, #ffe7ac);
      animation: secBar 1.8s infinite ease-in-out;
    }
    @keyframes secBar {
      0% { width: 0%; }
      50% { width: 85%; }
      100% { width: 0%; }
    }

    :root {
      --sec-bg-deep: #02030a;
      --sec-bg-top: #080f24;
      --sec-gold: #d6b15f;
      --sec-gold-soft: #f0d58b;
      --sec-text-main: #e3e4f2;
      --sec-text-muted: #b4b7d8;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      background: #000;
      color: var(--sec-text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body {
      display: flex;
      justify-content: center;
    }

    #sec-bg-layer {
      position: fixed;
      inset: 0;
      z-index: -2;
      background:
        radial-gradient(circle at 0% 0%, rgba(214,177,95,0.17) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(88,120,255,0.16) 0, transparent 55%),
        radial-gradient(circle at 50% 100%, #010314 0, #000 70%);
    }

    .smoke-layer {
      position: absolute;
      inset: -20%;
      pointer-events: none;
      background:
        radial-gradient(circle at 20% 20%, rgba(120,140,200,0.12) 0, transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(120,140,200,0.10) 0, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(80,100,160,0.12) 0, transparent 45%);
      opacity: 0;
      animation: smokeFade 1.4s ease forwards .8s, smokeDrift 40s linear infinite;
      mix-blend-mode: screen;
    }
    .smoke-layer.smoke-back {
      filter: blur(22px);
      animation: smokeFade 1.8s ease forwards 1s, smokeDrift 55s linear infinite;
    }
    @keyframes smokeFade { from { opacity:0;} to{opacity:0.4;} }
    @keyframes smokeDrift {
      0% { transform:translate3d(0,0,0) scale(1);}
      50%{ transform:translate3d(-4%,-2%,1px) scale(1.05);}
      100%{transform:translate3d(3%,3%,0) scale(1);}
    }

    #sec-page {
      width: 95%;
      max-width: 1200px;
      padding: 20px 12px 80px 12px;
      animation: pageFade .6s ease-out;
    }
    @keyframes pageFade {
      from { opacity:0; transform: translateY(8px);}
      to { opacity:1; transform: translateY(0);}
    }

    .back-button {
      display: inline-block;
      cursor: pointer;
      color: var(--sec-gold-soft);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 12px;
      padding: 8px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(214,177,95,0.35);
      box-shadow: 0 0 18px rgba(214,177,95,0.15);
      transition: 0.2s;
      width: fit-content;
    }
    .back-button:hover {
      background: rgba(255,215,0,0.15);
      color: #fff;
      transform: translateX(-3px);
    }

    .sfc-header {
      margin-top: 12px;
      border-radius: 22px;
      padding: 26px 16px 22px;
      background:
        linear-gradient(145deg, rgba(255,255,255,0.05), transparent 40%),
        radial-gradient(circle at top, #151b3f 0, #050614 55%, #02030a 100%);
      border: 1px solid rgba(214,177,95,0.6);
      box-shadow: 0 20px 60px rgba(0,0,0,0.95);
      text-align: center;
    }
    .sfc-logo {
      width: 165px;
      filter: drop-shadow(0 0 20px rgba(214,177,95,0.7));
    }
    .sfc-title {
      font-weight: 800;
      font-size: clamp(1.3rem, 2.6vw, 1.7rem);
      letter-spacing: .18em;
      text-transform: uppercase;
      margin-top: 6px;
    }
    .sfc-title strong { color: var(--sec-gold-soft); }
    .sfc-divider {
      width: 180px;
      height: 3px;
      margin: 18px auto 0;
      border-radius: 999px;
      background: linear-gradient(90deg,transparent,var(--sec-gold-soft),transparent);
      box-shadow: 0 0 15px rgba(214,177,95,0.8);
    }

    .player-shell {
      margin-top: 32px;
      width: 95%;
      max-width: 1100px;
      margin-inline: auto;
    }

    /* LAGKORTET */
    .team-card {
      width: 100%;
      border-radius: 22px;
      background:
        radial-gradient(circle at top, rgba(255,255,255,0.04), transparent 55%),
        linear-gradient(180deg, #060715, #02030a 60%, #000);
      border:1px solid rgba(255,255,255,0.06);
      padding:24px 20px 28px;
      text-align:center;
    }

    #teamLogo {
      width: 260px;
      max-width: 95%;
      border-radius:20px;
      padding:6px;
      background:#050712;
      border:2px solid rgba(255,215,0,.35);
      margin-bottom:12px;
      object-fit: contain;
    }

    #teamName {
      font-size:1.6rem;
      font-weight:700;
      color:#f5d86e;
      letter-spacing:.06em;
      text-transform:uppercase;
      margin-bottom:4px;
    }

    .team-subtitle {
      font-size:.88rem;
      color:var(--sec-text-muted);
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .ca-line {
      font-size:.9rem;
      color:var(--sec-text-main);
      margin-top:6px;
    }
    .ca-line span {
      font-weight:600;
      color:#f5d86e;
    }

    .no-stats {
      margin-top:10px;
      background:#3a0000;
      border:1px solid #ff4d4d;
      padding:10px;
      border-radius:10px;
      text-align:center;
      font-size:0.9rem;
    }

    .lag-section {
      margin-top: 28px;
      text-align: left;
    }
    .lag-section-title {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: #f5d86e;
      margin-bottom: 6px;
    }
    .lag-section-card {
      border-radius: 16px;
      background: rgba(2,4,18,0.96);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 14px 14px 10px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.8);
    }

    .match-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: .9rem;
    }
    .match-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      border-radius:10px;
      background:#101326;
    }
    .match-row-main { font-weight:500; }
    .match-row-sub {
      font-size:.78rem;
      color:var(--sec-text-muted);
    }
    .match-score {
      font-weight:700;
      min-width:48px;
      text-align:right;
    }

   .roster-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 26px 28px;
  justify-items: center;
  align-items: start;
  text-align: center;
}


.roster-item-main {
  font-weight: 600;
  margin-top: 6px;
  font-size: 1rem;
}

.roster-item-sub {
  font-size: 0.85rem;
  margin-top: 2px;
  color: var(--sec-text-muted);
}



    /* S√ñKMODUL */
    .player-search-centered {
      margin: 40px auto 10px auto;
      width: 50%;
      max-width: 550px;
      min-width: 260px;
      border-radius: 22px;
      text-align: center;
      background:
        radial-gradient(circle at top, rgba(255,255,255,0.05) 0, transparent 55%),
        linear-gradient(180deg, #050718, #02030a 70%, #000);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 20px 18px 22px;
    }
    .search-title {
      font-size: .92rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      font-weight: 600;
      color: var(--sec-text-muted);
      margin-bottom: 6px;
    }
    .player-search-centered .search-wrapper {
      position: relative;
    }
    #globalSearch {
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(245,216,110,.7);
      background: rgba(2,4,18,0.95);
      color: #fff;
      font-size: .95rem;
    }
    #globalSearch::placeholder {
      color: rgba(180,183,216,0.75);
    }
    #globalResults {
      position:absolute;
      top: calc(100% + 6px);
      left: 0;
      width:100%;
      background:#090b17;
      border:1px solid rgba(255,215,0,.25);
      border-radius:14px;
      display:none;
      max-height:260px;
      overflow-y:auto;
      z-index:100;
    }
    .search-item {
      padding:9px 14px;
      color:#ddd;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .search-item:hover {
      background:rgba(255,215,0,.08);
      color:#f5d86e;
    }
    .search-pill {
      font-size:.75rem;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(245,216,110,.7);
      color:#f5d86e;
    }
    .search-sub {
      font-size:.78rem;
      color:var(--sec-text-muted);
    }

    /* Footer */
    #sec-footer-wrapper {
      margin-top: 30px;
      padding-top: 18px;
      border-top: 1px solid rgba(214,177,95,0.35);
      text-align: center;
      font-size: 0.8rem;
      color: var(--sec-text-muted);
    }
    #sec-footer-wrapper span {
      color: var(--sec-gold-soft);
      font-weight: 600;
    }

    @media (max-width: 600px) {
      .player-search-centered { width: 90%; }
      #teamLogo { width: 220px; }
    }
 @media (max-width: 600px) {
  .roster-grid {
    grid-template-columns: repeat(1, 1fr);
    gap: 24px;
  }

  .player-mini {
    width: 120px;
    height: 165px;
  }
}
/* Wrapper around each player */
.player-card {
  position: relative;
  text-align: center;
  animation: fadeIn 0.6s ease forwards;
}

/* Player image */
.player-mini {
  width: 135px;
  height: 185px;
  border-radius: 16px;
  border: 2px solid rgba(245,216,110,0.55);
  background: #050712;
  object-fit: cover;
  box-shadow: 0 0 14px rgba(245,216,110,0.18);
  transition: 0.25s;
}

.player-mini:hover {
  transform: translateY(-4px);
  box-shadow: 0 0 22px rgba(245,216,110,0.35);
}

/* Grid layout */
.roster-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
  gap: 32px 28px;
  justify-items: center;
  align-items: start;
}

/* Player name */
.roster-item-main {
  font-weight: 700;
  margin-top: 8px;
  font-size: 1.05rem;
  color: #fff;
}

/* Stats under player */
.roster-item-sub {
  font-size: 0.85rem;
  color: var(--sec-text-muted);
  margin-top: 3px;
  line-height: 1.4;
}

/* Badges top-right */
.player-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  padding: 4px 7px;
  border-radius: 10px;
  background: rgba(0,0,0,0.65);
  border: 1px solid rgba(245,216,110,0.55);
  font-size: 1.05rem;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
}

.gold { color: #f5d86e; }
.silver { color: #d0d0d0; }
.bronze { color: #cd7f32; }

/* MVP highlight */
.mvp-glow {
  box-shadow: 0 0 30px rgba(255,215,0,0.45) !important;
  border-color: gold !important;
}

/* Fade-in animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Mobile layout */
@media (max-width: 600px) {
  .roster-grid {
    grid-template-columns: 1fr;
    gap: 28px;
  }
  .player-mini {
    width: 160px;
    height: 215px;
  }
}


  </style>
</head>

<body>
  <div id="sec-bg-layer">
    <div class="smoke-layer smoke-back"></div>
    <div class="smoke-layer"></div>
  </div>

  <div id="sec-page">
    <div class="back-button" onclick="history.back()">
      ‚Üê Tillbaka
    </div>

    <a href="https://sweehockey-svg.github.io/SEC/index.html" style="text-decoration:none; color:inherit;">
      <div class="sfc-header">
        <img class="sfc-logo" src="https://drive.google.com/thumbnail?id=1QybW_Uw8HO0OXo8vwQFD-zrrr-ifFrC9&sz=w1000" alt="SEC Logo">
        <div class="sfc-title">
          üèÜ Svenska eHockey <strong>Cupen</strong> üèí
        </div>
        <div class="sfc-divider"></div>
      </div>
    </a>

    <div class="player-shell">
      <div class="team-card">
        <img
  id="teamLogo"
  alt="Laglogga"
  src="https://drive.google.com/thumbnail?id=1QybW_Uw8HO0OXo8vwQFD-zrrr-ifFrC9&sz=w1000"
  onerror="this.onerror=null;this.src='https://drive.google.com/thumbnail?id=1QybW_Uw8HO0OXo8vwQFD-zrrr-ifFrC9&sz=w1000';"
/>

        
        <div id="teamName">Lagnamn</div>
        <div class="team-subtitle" id="teamCup">SEC</div>
        <div class="ca-line" id="caLine" style="display:none;"></div>

        <div id="teamLoader" class="sec-loader" style="display:none;">
          <div class="loader-text">Lagsida laddas‚Ä¶</div>
          <div class="loader-bar">
            <div class="loader-bar-fill"></div>
          </div>
        </div>

        

        <!-- SPELARE -->
        <div class="lag-section">
          <div class="lag-section-title">Spelare</div>
          <div class="lag-section-card">
            <div id="playerList" class="roster-grid">
              <div class="roster-item-main" style="opacity:.7;">Inga spelare hittades.</div>
            </div>
          </div>
        </div>

        <!-- M√ÖLVAKTER -->
        <div class="lag-section">
          <div class="lag-section-title">M√•lvakter</div>
          <div class="lag-section-card">
            <div id="goalieList" class="roster-grid">
              <div class="roster-item-main" style="opacity:.7;">Inga m√•lvakter hittades.</div>
            </div>
          </div>
        </div>
      </div>
<!-- MATCHER -->
        <div class="lag-section">
          <div class="lag-section-title">Matcher</div>
          <div class="lag-section-card">
            <div id="matchList" class="match-list">
              <div class="match-row">
                <div>
                  <div class="match-row-main">Inga matcher hittades.</div>
                  <div class="match-row-sub"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      <!-- S√ñK: LAG + SPELARE -->
      <div class="player-search-centered">
        <div class="search-title">S√∂k lag &amp; spelare</div>
        <div class="search-wrapper">
          <input id="globalSearch" placeholder="S√∂k lag eller spelare">
          <div id="globalResults"></div>
        </div>
      </div>
    </div>

    <div id="sec-footer-wrapper">
      ¬© 2025 <span>Svenska eHockey Cupen</span> | Design & utveckling av <span>SWEEHOCKEY</span>
    </div>
  </div>

  <script>
    const API = "https://script.google.com/macros/s/AKfycbwUvylvIbUTy4_zihW5_OKIsQME2vxcPHWLldObZI28dggqJytvF2UmdsAD4Ib5Zre1/exec";
let playerPhotos = {};

async function loadPlayerPhotos() {
  try {
    const res = await fetch(API + "?sheet=Spelarfoton");
    const data = await res.json();

    const h = data[0];
    const iName = h.indexOf("Spelarnamn");
    const iDriveID = h.indexOf("DriveID");

    for (let i = 1; i < data.length; i++) {
      const r = data[i];
      if (!r) continue;

      const name = r[iName];
      const id = r[iDriveID];

      if (!name || !id) continue;

      playerPhotos[name.trim()] = `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
    }
  } catch (e) {
    console.error("Foto-fel:", e);
  }
}


    // TEAM_MAP (kortad ‚Äì fyll p√• med hela listan du har)
    const TEAM_MAP = {
      "3TU":"3Tuna Le sport","AL":"A Laget","AFT":"AFTERLIFE","AIS":"Almtuna ESPORT",
      "AVE":"Avenyn Esport","BAC":"BACKCHECK BOYS","BAS":"Bask Nation","BEE":"Beerhouse",
      "BIF":"Bryn√§s IF Esport","CAL":"Calippo HC","COG":"Company of Geeks","DIF":"Djurg√•rden",
      "FBK":"F√§rjestad BK","FHC":"Fr√∂lunda HC Academy","FR":"Fr√∂lunda HC Region",
      "MOD":"Modo Hockey","MIK":"Mora IK","MIF":"Malm√∂","NF":"Nordic Falcons",
      "NK":"Nordic Knights","NOF":"Norska f√∂rbundslaget","NVB":"Norra V√§sterbotten",
      "OBK":"√ñrebro","OIK":"Oskarshamn IK","PAT":"Patriots","PRO":"Prowlers Esport",
      "RBK":"R√∂gle","SES":"Sunne IK Esport","SPA":"Spartans eSport","SSK":"SSK eSport",
      "TIK":"Timr√• IK","TMO":"Team Modo","UNW":"Unwanted","VAX":"V√§xjo",
      "VIK":"V√§ster√•s IK","VER":"Verket","WHI":"WHITE WINGS","WIS":"Wisby Islanders"
      // ...resten av din fulla TEAM_MAP h√§r
    };

    function norm(s){
      return String(s||"")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g,"")
        .replace(/[^a-z0-9]/g,"");
    }
/* ================================
   CUP-PARSER (ROBUST)
================================ */
function extractCupNumber(c) {
  if (!c) return "";
  return String(c)
    .replace("SEC", "")
    .replace(/[^\d.]/g, "")   // beh√•ll ENDAST siffror
    .replace(/^0+/, "")       // 01 ‚Üí 1
    .trim();
}
/* ================================
   CUP + STAGE PARSER (NY)
================================ */
function extractCupAndStage(cupRaw) {
  if (!cupRaw) return { cup: null, stage: null };

  const str = cupRaw.toString().trim();

  const cupMatch   = str.match(/(\d+(?:\.\d+)?)/); // 19.5 ‚Üí cup
  const stageMatch = str.match(/\b(G|S)\b/i);      // G / S

  return {
    cup: cupMatch ? Number(cupMatch[1]) : null,
    stage: stageMatch ? stageMatch[1].toUpperCase() : null
  };
}

/* ================================
   DATUMPARSER (ALLTID VALID)
================================ */
function parseSecDate(d, t) {
  if (!d) return new Date();

  // Ta bort veckodag f√∂rst
  const clean = d.replace(/^[A-Za-z√•√§√∂√Ö√Ñ√ñ]+ /, "");

  // Skapa ett datum som JS alltid f√∂rst√•r
  const date = new Date(clean + " " + (t || "00:00"));

  return date instanceof Date && !isNaN(date) ? date : new Date();
}

/* ================================
   DATUMFORMAT (SVENSKA VECKODAGAR)
================================ */
function formatDate(date) {
  const d = new Date(date);
  return d.toLocaleDateString("sv-SE", {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric"
  });
}

/* ================================
   LADDA MATCHER (F√ÑRDIGT BLOCK)
================================ */
async function loadMatches() {
  try {
    const res = await fetch(API + "?sheet=matcherSEC");
    const data = await res.json();
    const h = data[0];

    const iDate  = h.indexOf("Date");
    const iTime  = h.indexOf("Time");
    const iAway  = h.indexOf("Away team");
    const iHome  = h.indexOf("Home team");
    const iAS    = h.indexOf("Away score");
    const iHS    = h.indexOf("Home score");
    const iCup   = h.indexOf("Cup");
    const iStage = h.indexOf("Stage");

    const normTeam = norm(teamParam);
    const possibleTeamNames = new Set([normTeam]);

    // L√§gg till alias fr√•n TEAM_MAP
    for (const code in TEAM_MAP) {
      if (norm(TEAM_MAP[code]) === normTeam) {
        possibleTeamNames.add(norm(TEAM_MAP[code]));
        possibleTeamNames.add(norm(code));
      }
    }

    const list = [];

    for (let i = 1; i < data.length; i++) {
      const r = data[i];
      if (!r) continue;

      const cup = extractCupNumber(r[iCup]);
      if (cupParam && norm(cup) !== norm(cupParam)) continue;

      const home = r[iHome];
      const away = r[iAway];

      const nh = norm(home);
      const na = norm(away);

      if (!possibleTeamNames.has(nh) && !possibleTeamNames.has(na)) continue;

      list.push({
        date: r[iDate],
        time: r[iTime],
        home,
        away,
        hs: r[iHS],
        as: r[iAS],
        stage: r[iStage],
        cup
      });
    }

    const box = document.getElementById("matchList");

    if (!list.length) {
      box.innerHTML = `
        <div class="match-row">
          <div class="match-row-main">Inga matcher hittades.</div>
        </div>`;
      return;
    }

    // üî• Sortera korrekt efter verkligt datum
    list.sort((a, b) => {
      const da = parseSecDate(a.date, a.time);
      const db = parseSecDate(b.date, b.time);
      return da - db;
    });

    // üî• Render
    box.innerHTML = list
      .map(m => `
        <div class="match-row">
          <div>
            <div class="match-row-main">${m.home} ‚Äì ${m.away}</div>
            <div class="match-row-sub">
              ${formatDate(parseSecDate(m.date, m.time))} ${m.time || ""} ¬∑ ${m.stage || ""}
            </div>
          </div>
          <div class="match-score">${m.hs ?? ""}‚Äì${m.as ?? ""}</div>
        </div>
      `)
      .join("");

  } catch (e) {
    console.error("Matcher-fel", e);
  }
}


    const params = new URLSearchParams(location.search);
    const teamParam = params.get("team") ? decodeURIComponent(params.get("team")) : "";
    const cupParam  = params.get("cup")  || "";

    const teamNameEl = document.getElementById("teamName");
    const teamCupEl  = document.getElementById("teamCup");
    const logoEl     = document.getElementById("teamLogo");
    const caLineEl   = document.getElementById("caLine");
    const loaderEl   = document.getElementById("teamLoader");

    teamNameEl.textContent = teamParam || "Ok√§nt lag";
    teamCupEl.textContent  = cupParam ? `SEC ${cupParam}` : "Svenska eHockey Cupen";

async function loadLogo() {
  try {
    const res = await fetch(API + "?sheet=lagloggor");
    const data = await res.json();

    const header = data[0];
    const iLag  = header.indexOf("Laglogga");
    const iLink = header.indexOf("Drive-l√§nk");
    const iId   = header.indexOf("DriveID");

    if (iLag === -1 || iId === -1) return;

    const targetNorm = norm(teamParam);
    let driveId = "";
    let directLink = "";

    // üîé 1. EXAKT NORMALISERAD MATCHNING
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (!row) continue;

      const name = row[iLag];
      if (!name) continue;

      if (norm(name) === targetNorm) {
        driveId = row[iId];
        directLink = row[iLink];
        break;
      }
    }

    // üîé 2. SN√ÑLL MATCHNING (fallback)
    if (!driveId) {
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row) continue;

        const name = row[iLag];
        if (!name) continue;

        const n = norm(name);
        if (targetNorm.includes(n) || n.includes(targetNorm)) {
          driveId = row[iId];
          directLink = row[iLink];
          break;
        }
      }
    }

    // üé® Bygg bild-url korrekt
    if (driveId) {
      logoEl.src = `https://drive.google.com/thumbnail?id=${driveId}&sz=w1000`;
    } else if (directLink) {
      // Om n√•gon lagt in en direkt Drive-l√§nk i arket
      const match = directLink.match(/\/d\/([^/]+)/);
      const id = match ? match[1] : "";
      logoEl.src = `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
    } else {
      // üü° Fallback ‚Üí SEC-logo
      logoEl.src = "https://drive.google.com/thumbnail?id=1QybW_Uw8HO0OXo8vwQFD-zrrr-ifFrC9&sz=w1000";
      console.warn("Ingen logga hittades f√∂r:", teamParam);
    }

  } catch (e) {
    console.error("Logo-fel:", e);
    logoEl.src = "https://drive.google.com/thumbnail?id=1QybW_Uw8HO0OXo8vwQFD-zrrr-ifFrC9&sz=w1000";
  }
}


async function getPlayerPhotoMap() {
  const res = await fetch(API + "?sheet=Spelarfoton");
  const data = await res.json();

  const header = data[0];
  const iName = header.indexOf("Spelarnamn");
  const iId   = header.indexOf("DriveID");

  const map = {};

  for (let i = 1; i < data.length; i++) {
    const r = data[i];
    if (!r) continue;

    const name = r[iName];
    const id   = r[iId];

    if (name && id) {
      map[name.trim().toLowerCase()] = id;
    }
  }

  return map;
}

// fallback-bild (samma som spelarkortet)
const FALLBACK_PLAYER_IMG =
  "https://drive.google.com/thumbnail?id=1VAa79pJ-QbyeliY60autf914z6SBwmhp&sz=w1000";


async function loadRoster() {
  try {
    loaderEl.style.display = "flex";

    await loadPlayerPhotos();

    const [uteRes, mvRes] = await Promise.all([
      fetch(API + "?sheet=utestatsall").then(r => r.json()),
      fetch(API + "?sheet=m√•lvaktsstatsall").then(r => r.json())
    ]);

    // =========================
    //  PO√ÑNGLIGAN ‚Äì TOPP 3 PER CUP
    // =========================
    const cupLeaders = (() => {
      if (!uteRes || uteRes.length < 2) return {};

      const h = uteRes[0];
      const iPlayer = h.indexOf("PLAYERS");
      const iCup    = h.indexOf("CUP");
      const iPTS    = h.indexOf("PTS");
      const iG      = h.indexOf("G");
      const iA      = h.indexOf("A");

      if (iPlayer === -1 || iCup === -1 || iPTS === -1) return {};

      const perCup = {}; // cup -> array of {name, pts, g, a}

      for (let i = 1; i < uteRes.length; i++) {
        const r = uteRes[i];
        if (!r) continue;

        const rawName = r[iPlayer];
        if (!rawName) continue;

        const name = rawName.replace(/,\s*[A-Z]{2,3}$/i, "").trim();
        if (!name) continue;

        const cupNumber = extractCupNumber(r[iCup]);
        if (!cupNumber) continue;

        // Vi k√∂r bara p√• grundserien ‚Äì skippa rader med "Slutspel"
        if (typeof r[iCup] === "string" && r[iCup].includes("Slutspel")) continue;

        const keyCup = String(cupNumber);
        if (!perCup[keyCup]) perCup[keyCup] = [];

        perCup[keyCup].push({
          name,
          pts: Number(r[iPTS] || 0),
          g:   iG !== -1 ? Number(r[iG] || 0) : 0,
          a:   iA !== -1 ? Number(r[iA] || 0) : 0
        });
      }

      const leaders = {}; // cup -> { [name]: {place} }

      Object.keys(perCup).forEach(cup => {
        const arr = perCup[cup];

        arr.sort((a, b) => {
          if (b.pts !== a.pts) return b.pts - a.pts;
          if (b.g   !== a.g)   return b.g   - a.g;
          if (b.a   !== a.a)   return b.a   - a.a;
          return a.name.localeCompare(b.name);
        });

        leaders[cup] = {};
        arr.slice(0, 3).forEach((p, idx) => {
          leaders[cup][p.name] = { place: idx + 1 };
        });
      });

      return leaders;
    })();

    const currentCupKey = cupParam ? String(cupParam) : null;

    // =========================
    //  UTE SPELARE
    // =========================
    (function () {
      const h = uteRes[0];
      const iPlayer = h.indexOf("PLAYERS");
      const iTeam   = h.indexOf("TEAM");
      const iGP     = h.indexOf("GP");
      const iPTS    = h.indexOf("PTS");
      const iCup    = h.indexOf("CUP");

      const merged = {};

      for (let i = 1; i < uteRes.length; i++) {
        const r = uteRes[i];
        if (!r) continue;

        const code = r[iTeam];
        const fullTeam = TEAM_MAP[code] || code;
        const cup = extractCupNumber(r[iCup]);
        if (fullTeam !== teamParam) continue;
        if (cupParam && cup !== cupParam) continue;

        const nameRaw = r[iPlayer];
        if (!nameRaw) continue;

        const clean = nameRaw.replace(/,\s*[A-Z]{2,3}$/i, "").trim();
        if (!clean) continue;

        if (!merged[clean]) {
          merged[clean] = {
            name: clean,
            gp: 0,
            pts: 0,
            stages: new Set()
          };
        }

        merged[clean].gp  += Number(r[iGP]  || 0);
        merged[clean].pts += Number(r[iPTS] || 0);

        if (r[iCup].includes("Grupp"))    merged[clean].stages.add("Grupp");
        if (r[iCup].includes("Slutspel")) merged[clean].stages.add("Slutspel");
      }

      const rows = Object.values(merged);
      const box = document.getElementById("playerList");

      if (!rows.length) {
        box.innerHTML = '<div class="roster-item-main" style="opacity:.7;">Inga spelare hittades.</div>';
        return;
      }

      box.innerHTML = rows
        .map(p => {
          const photo = playerPhotos[p.name] || FALLBACK_PLAYER_IMG;
          const stage = [...p.stages].join(" + ");

          // Medalj-info f√∂r aktuell cup
          let medalHtml = "";
          if (currentCupKey && cupLeaders[currentCupKey] && cupLeaders[currentCupKey][p.name]) {
            const place = cupLeaders[currentCupKey][p.name].place;
            const icon =
              place === 1 ? "ü•á" :
              place === 2 ? "ü•à" :
              place === 3 ? "ü•â" : "";

            const placeText = place + ":a i po√§ngligan (SEC " + currentCupKey + ")";
            medalHtml = `
              <div class="roster-medal-text">
                ${icon} ${placeText}
              </div>
            `;
          }

          return `
            <div class="roster-card">
              <a href="players?player=${encodeURIComponent(p.name)}"
                 style="text-decoration:none; color:inherit;">
                <img src="${photo}" class="player-mini">
                <div class="roster-item-main">${p.name}</div>
              </a>
              ${medalHtml}
              <div class="roster-item-sub">
                GP: ${p.gp} ¬∑ PTS: ${p.pts} ¬∑ ${stage}
              </div>
            </div>
          `;
        })
        .join("");
    })();

/* ============================================================
   ============ M√ÖLVAKTER MED MEDALJER (SLUTVERSION) ============
   ============================================================ */

(function () {

  const h = mvRes[0];

  const iGoalie = h.indexOf("GOALIES");
  const iTeam   = h.indexOf("TEAM");
  const iCup    = h.indexOf("CUP");
  const iGP     = h.indexOf("GP");
  const iSVpct  = h.indexOf("SV%");
  const iSV     = h.indexOf("SV");
  const iGA     = h.indexOf("GA");

  /* ============================================================
        1. BYGG SEPARATA LIGOR F√ñR G & S
     ============================================================ */

  const goalieLeague = (() => {
    const perCupStage = {};  // ex: { "19.5_G": [...], "19.5_S": [...] }

    for (let i = 1; i < mvRes.length; i++) {
      const r = mvRes[i];
      if (!r) continue;

      const nameRaw = r[iGoalie];
      if (!nameRaw) continue;
      const name = nameRaw.replace(/,\s*[A-Z]{2,3}$/i, "").trim();

      const { cup, stage } = extractCupAndStage(r[iCup]);
      if (!cup || !stage) continue;

      // Ligor byggs b√•de f√∂r G och S
      let svNum = null;
      const rawSVpct = (r[iSVpct] || "").trim();

      if (rawSVpct && rawSVpct !== "-") {
        svNum = Number(rawSVpct.replace(",", "."));
      } else {
        const saves = Number(r[iSV] || 0);
        const ga    = Number(r[iGA] || 0);
        if (saves + ga > 0) svNum = Number((saves / (saves + ga)).toFixed(3));
      }

      if (svNum == null) continue;

      const key = `${cup}_${stage}`;
      if (!perCupStage[key]) perCupStage[key] = [];

      perCupStage[key].push({
        name,
        sv: svNum,
        gp: Number(r[iGP] || 0)
      });
    }

    // TOPP 3 per cup/stage
    const out = {};
    for (const key of Object.keys(perCupStage)) {
      const list = perCupStage[key];

      list.sort((a, b) => {
        if (b.sv !== a.sv) return b.sv - a.sv;
        return b.gp - a.gp;
      });

      out[key] = {};
      list.slice(0, 3).forEach((g, idx) => {
        out[key][g.name] = { place: idx + 1 };
      });
    }

    return out;
  })();



  /* ============================================================
        2. MERGA M√ÖLVAKTSSTATS PER LAG
     ============================================================ */

  const merged = {}; // name ‚Üí { gpG, gpS, svG, svS }

  for (let i = 1; i < mvRes.length; i++) {
    const r = mvRes[i];
    if (!r) continue;

    const code = r[iTeam];
    const fullTeam = TEAM_MAP[code] || code;

    const { cup, stage } = extractCupAndStage(r[iCup]);

    if (fullTeam !== teamParam) continue;

    // FIX: cup filter m√•ste matcha STR√ÑNG
    if (cupParam && String(cup) !== String(cupParam)) continue;

    const nameRaw = r[iGoalie];
    if (!nameRaw) continue;
    const name = nameRaw.replace(/,\s*[A-Z]{2,3}$/i, "").trim();

    if (!merged[name]) {
      merged[name] = {
        name,
        gpG: 0,
        gpS: 0,
        svG: null,
        svS: null
      };
    }

    const gp = Number(r[iGP] || 0);
    const rawSVpct = (r[iSVpct] || "").trim();
    const saves = Number(r[iSV] || 0);
    const ga    = Number(r[iGA] || 0);

    let svCalc = null;

    if (rawSVpct && rawSVpct !== "-") {
      svCalc = Number(rawSVpct.replace(",", "."));
    } else if (saves + ga > 0) {
      svCalc = Number((saves / (saves + ga)).toFixed(3));
    }

    if (stage === "G") {
      merged[name].gpG += gp;
      if (svCalc !== null) merged[name].svG = svCalc;
    }

    if (stage === "S") {
      merged[name].gpS += gp;
      if (svCalc !== null) merged[name].svS = svCalc;
    }
  }



  /* ============================================================
        3. UTSKRIFT
     ============================================================ */

  const box = document.getElementById("goalieList");
  const rows = Object.values(merged);

  if (!rows.length) {
    box.innerHTML = '<div class="roster-item-main" style="opacity:.7;">Inga m√•lvakter hittades.</div>';
    return;
  }

  box.innerHTML = rows.map(g => {
    const photo = playerPhotos[g.name] || FALLBACK_PLAYER_IMG;

    let medalHtml = "";
    const keyG = `${cupParam}_G`;

    if (goalieLeague[keyG] && goalieLeague[keyG][g.name]) {
      const place = goalieLeague[keyG][g.name].place;
      const icon =
        place === 1 ? "ü•á" :
        place === 2 ? "ü•à" :
        place === 3 ? "ü•â" : "";

      medalHtml = `
        <div class="roster-medal-text">
          ${icon} ${place}:a i m√•lvaktsligan (SEC ${cupParam} G)
        </div>
      `;
    }

    /* Format i procent */
    const svG = g.svG != null ? (g.svG * 100).toFixed(1) : "-";
    const svS = g.svS != null ? (g.svS * 100).toFixed(1) : "-";

    return `
      <div class="roster-card">
        <a href="players?player=${encodeURIComponent(g.name)}"
           style="text-decoration:none; color:inherit;">
          <img src="${photo}" class="player-mini">
          <div class="roster-item-main">${g.name}</div>
        </a>

        ${medalHtml}

        <div class="roster-item-sub">
          GP G: ${g.gpG} ¬∑ SV% G: ${svG}<br>
          GP S: ${g.gpS} ¬∑ SV% S: ${svS}
        </div>
      </div>
    `;
  }).join("");

})();




} catch (e) {
  console.error("Roster-fel", e);
} finally {
  loaderEl.style.display = "none";
}
}


// Init
loadLogo();
loadMatches();
loadRoster();
initGlobalSearch();


  </script>
</body>
</html>
