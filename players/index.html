<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spelarkort ‚Äì Svenska eHockey Cupen</title>
  <link rel="stylesheet" href="../assets/style.css" />
  <style>
    body {
      margin: 0; font-family: Inter, system-ui, Arial, sans-serif;
      background: #000; color: #fff; display: flex; justify-content: center;
    }
    #sec-page { width: 100%; max-width: 1200px; padding: 20px 12px 80px; }
    .sfc-header {
      margin-top: 12px; border-radius: 22px; padding: 26px 16px 22px;
      background: radial-gradient(circle at top, #151b3f 0, #050614 55%, #02030a 100%);
      border: 1px solid rgba(214,177,95,0.6); text-align:center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.95);
    }
    .sfc-logo { width: 165px; }
    .sfc-title { font-weight: 800; font-size: 1.7rem; letter-spacing: 0.18em;
      text-transform: uppercase; color: #fff; margin-top: 4px; }
    .sfc-title strong { color: #f0d58b; }
    .player-hero { text-align: center; padding: 20px 12px 10px; }
    .player-photo { width: 240px; border-radius: 20px; border: 2px solid #d6b15f;
      box-shadow: 0 0 25px rgba(214,177,95,0.25), 0 12px 40px rgba(0,0,0,0.9);
      transition: transform .3s ease; }
    .player-photo:hover { transform: scale(1.05); }
    .player-nick {
      margin: 22px 0 4px; font-size: 2.6rem; font-weight: 800;
      background: linear-gradient(90deg,#fff,#f0d58b);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .goalie-wrap-inner {
      background:#101526; border-radius:12px; overflow-x:auto;
      box-shadow:0 6px 18px rgba(0,0,0,0.3); padding:4px; margin-top:16px;
    }
    .lastUpdated { font-size: 13px; color: #888; margin-top: 8px; text-align: right; }
  </style>
</head>
<body>
  <div id="sec-page">
    <div class="sfc-header">
      <img src="https://drive.google.com/thumbnail?id=1QybW_Uw8HO0OXo8vwQFD-zrrr-ifFrC9&sz=w1000" class="sfc-logo">
      <div class="sfc-title">üèÜ Svenska eHockey <strong>Cupen</strong> üèí</div>
    </div>

    <div class="player-hero">
      <img src="" alt="Spelarfoto" class="player-photo" />
      <h1 class="player-nick"></h1>
      <p class="player-meta">Statistik fr√•n Svenska eHockey Cupen</p>
    </div>

    <div id="player-stats" class="goalie-wrap-inner">ü•Ö Laddar statistik...</div>
    <p id="updated" class="lastUpdated"></p>
  </div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const API_BASE = "https://script.google.com/macros/s/AKfycbzbvB-icGFm7WeYDQwY1yZRpTMnIYKRAPJDeabb2NhoGdE6m7nYDJT8R1I5atQW9Ie9/exec";
  const defaultPhoto = "1VAa79pJ-QbyeliY60autf914z6SBwmhp";
  const manualPlayer = "DobbyTheJoker_";

  // L√§s ?player=
  const params = new URLSearchParams(window.location.search);
  let player = params.get("player") || manualPlayer;
  player = decodeURIComponent(player);
  const playerKey = player.toLowerCase().replace(/\s+/g, "");

  document.querySelector(".player-nick").textContent = player;

  // --- H√§mta spelarfoto ---
  let photoId = defaultPhoto;
  try {
    const res = await fetch(`${API_BASE}?sheet=Spelarfoton&_t=${Date.now()}`);
    const rows = await res.json();
    const clean = s => String(s).toLowerCase().replace(/\s+/g, "").replace(/[^a-z0-9_]/g, "");
    const found = rows.find(r => clean(r.Spelarnamn) === clean(playerKey));
    if (found?.DriveID) photoId = found.DriveID;
  } catch(e){ console.warn("‚ö†Ô∏è Kunde inte h√§mta foto:", e); }
  document.querySelector(".player-photo").src = `https://drive.google.com/thumbnail?id=${photoId}&sz=w1000`;

  // --- H√§mta statistik ---
  const seasons = [19.5, ...Array.from({length: 19}, (_, i) => 19 - i)];
  const sheets = [];
  for (const s of seasons) {
    sheets.push({ name: `Spelarstats grupp ${s}`, label: `SEC ${s} G` });
    sheets.push({ name: `Spelarstats slut ${s}`, label: `SEC ${s} S` });
    sheets.push({ name: `M√•lvaktsstats grupp ${s}`, label: `SEC ${s} G` });
    sheets.push({ name: `M√•lvaktsstats slut ${s}`, label: `SEC ${s} S` });
  }

  const results = [];
  const cleanStat = s => String(s || "").toLowerCase().replace(/\s+/g, "").replace(/[^a-z0-9_]/g, "");

  for (const sheet of sheets) {
    try {
      const res = await fetch(`${API_BASE}?sheet=${encodeURIComponent(sheet.name)}&_t=${Date.now()}`);
      const rows = await res.json();
      if (!rows?.length) continue;
      const key = Object.keys(rows[0]).find(k => /goalie|m√•lvakt|spelare|player/i.test(k));
      const match = rows.find(r => cleanStat(r[key]) === cleanStat(playerKey));
      if (match) results.push({...match, __sheet: sheet.label});
    } catch(e){ console.warn("Fel i", sheet.name, e); }
  }

  const container = document.getElementById("player-stats");
  const updated = document.getElementById("updated");
  if (!results.length) {
    container.innerHTML = `<div style='padding:12px;color:#d6b15f;text-align:center;'>‚ùå Ingen statistik hittades f√∂r ${player}</div>`;
    return;
  }

  const headers = ["TURNERING", ...Object.keys(results[0]).filter(k => !/__sheet/i.test(k))];
  container.innerHTML = `
    <table>
      <thead><tr>${headers.map(h => `<th>${h.toUpperCase()}</th>`).join("")}</tr></thead>
      <tbody>
        ${results.map(r => `
          <tr>${headers.map(h =>
            `<td>${h === "TURNERING" ? r.__sheet : (r[h] ?? "")}</td>`
          ).join("")}</tr>
        `).join("")}
      </tbody>
    </table>`;
  updated.textContent = "Senast uppdaterad: " + new Date().toLocaleString("sv-SE", {
    day: "numeric", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit"
  });
});
</script>
</body>
</html>
