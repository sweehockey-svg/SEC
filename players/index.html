<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Svenska eHockey Cupen ‚Äì Spelarkort</title>

  <style>
.loader-wrapper {
  width: 100%;
  display: none;      /* visas via JS */
  justify-content: center;
  margin: 25px 0;
}

/* Kontainer f√∂r animationen */
/* Nya loadern */
.sec-loader {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px 0;
}

.loader-text {
  font-size: 1rem;
  color: #f6d66b;
  margin-bottom: 10px;
  letter-spacing: .04em;
}

.loader-bar {
  width: 200px;
  height: 10px;
  background: rgba(255,255,255,0.08);
  border-radius: 6px;
  border: 1px solid rgba(246,214,107,0.35);
  overflow: hidden;
  margin: 0 auto; /* üî• Centrera stapeln */
}

.loader-bar-fill {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, #f6d66b, #ffe7ac);
  animation: secBar 1.8s infinite ease-in-out;
}

@keyframes secBar {
  0% { width: 0%; }
  50% { width: 85%; }
  100% { width: 0%; }
}



    :root {
      --sec-bg-deep: #02030a;
      --sec-bg-top: #080f24;
      --sec-gold: #d6b15f;
      --sec-gold-soft: #f0d58b;
      --sec-text-main: #e3e4f2;
      --sec-text-muted: #b4b7d8;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      background: #000;
      color: var(--sec-text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body {
      display: flex;
      justify-content: center;
    }

    /* Bakgrund */
    #sec-bg-layer {
      position: fixed;
      inset: 0;
      z-index: -2;
      background:
        radial-gradient(circle at 0% 0%, rgba(214,177,95,0.17) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(88,120,255,0.16) 0, transparent 55%),
        radial-gradient(circle at 50% 100%, #010314 0, #000 70%);
    }

    .smoke-layer {
      position: absolute;
      inset: -20%;
      pointer-events: none;
      background:
        radial-gradient(circle at 20% 20%, rgba(120,140,200,0.12) 0, transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(120,140,200,0.10) 0, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(80,100,160,0.12) 0, transparent 45%);
      opacity: 0;
      animation: smokeFade 1.4s ease forwards .8s, smokeDrift 40s linear infinite;
      mix-blend-mode: screen;
    }

    .smoke-layer.smoke-back {
      filter: blur(22px);
      animation: smokeFade 1.8s ease forwards 1s, smokeDrift 55s linear infinite;
    }

    @keyframes smokeFade { from { opacity:0;} to{opacity:0.4;} }
    @keyframes smokeDrift {
      0% { transform:translate3d(0,0,0) scale(1);}
      50%{ transform:translate3d(-4%,-2%,1px) scale(1.05);}
      100%{transform:translate3d(3%,3%,0) scale(1);}
    }

    #sec-page {
      width: 95%;
      max-width: 1200px;
      padding: 20px 12px 80px 12px;
      animation: pageFade .6s ease-out;
    }

    @keyframes pageFade {
      from { opacity:0; transform: translateY(8px);}
      to { opacity:1; transform: translateY(0);}
    }

    /* TILLBAKA-KNAPP */
    .back-button {
      display: inline-block;
      cursor: pointer;
      color: var(--sec-gold-soft);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 12px;
      padding: 8px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(214,177,95,0.35);
      box-shadow: 0 0 18px rgba(214,177,95,0.15);
      transition: 0.2s;
      width: fit-content;
    }

    .back-button:hover {
      background: rgba(255,215,0,0.15);
      color: #fff;
      transform: translateX(-3px);
    }

    /* Header */
    .sfc-header {
      margin-top: 12px;
      border-radius: 22px;
      padding: 26px 16px 22px;
      background:
        linear-gradient(145deg, rgba(255,255,255,0.05), transparent 40%),
        radial-gradient(circle at top, #151b3f 0, #050614 55%, #02030a 100%);
      border: 1px solid rgba(214,177,95,0.6);
      box-shadow: 0 20px 60px rgba(0,0,0,0.95);
      text-align: center;
    }

    .sfc-logo {
      width: 165px;
      filter: drop-shadow(0 0 20px rgba(214,177,95,0.7));
    }

    .sfc-title {
      font-weight: 800;
      font-size: clamp(1.3rem, 2.6vw, 1.7rem);
      letter-spacing: .18em;
      text-transform: uppercase;
      margin-top: 6px;
    }

    .sfc-title strong {
      color: var(--sec-gold-soft);
    }

    .sfc-divider {
      width: 180px;
      height: 3px;
      margin: 18px auto 0;
      border-radius: 999px;
      background: linear-gradient(90deg,transparent,var(--sec-gold-soft),transparent);
      box-shadow: 0 0 15px rgba(214,177,95,0.8);
    }
    .player-shell {
      margin-top: 32px;
      width: 95%;
      max-width: 1100px;
      margin-inline: auto;
    }

    /* Spelarkort */
    .player-card {
      width: 100%;
      border-radius: 22px;
      background:
        radial-gradient(circle at top, rgba(255,255,255,0.04), transparent 55%),
        linear-gradient(180deg, #060715, #02030a 60%, #000);
      border:1px solid rgba(255,255,255,0.06);
      padding:24px 20px;
      text-align:center;
    }

    #playerPhoto {
      width: 260px;
      max-width: 95%;
      border-radius:20px;
      padding:6px;
      background:#050712;
      border:2px solid rgba(255,215,0,.35);
      margin-bottom:12px;
    }

    #playerName {
      font-size:1.6rem;
      font-weight:700;
      color:#f5d86e;
      letter-spacing:.06em;
      text-transform:uppercase;
      margin-bottom:6px;
    }

    .player-subtitle {
      font-size:.88rem;
      color:var(--sec-text-muted);
      margin-bottom:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    /* Tabell */
    .stats-table table {
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }

    .stats-table th {
      background:#0b1029;
      color:#f5c851;
      padding:9px 8px;
      text-align:right;
    }

    .stats-table th:first-child,
    .stats-table th:nth-child(2) {
      text-align:left;
    }

    .stats-table td {
      padding:8px 8px;
      border-bottom:1px solid #1b1f35;
      text-align:right;
    }

    .stats-table td:first-child,
    .stats-table td:nth-child(2) { text-align:left; }

    .stats-table tr:nth-child(even) {
      background: rgba(255,255,255,0.01);
    }

    .stats-table tr:hover {
      background: rgba(255,255,255,0.04);
    }

    .no-stats {
      margin-top:10px;
      background:#3a0000;
      border:1px solid #ff4d4d;
      padding:10px;
      border-radius:10px;
      text-align:center;
      font-size:0.9rem;
    }

    /* S√∂kmodul */
    .player-search-centered {
      margin: 40px auto 10px auto;
      width: 50%;
      max-width: 550px;
      min-width: 260px;
      border-radius: 22px;
      text-align: center;
      background:
        radial-gradient(circle at top, rgba(255,255,255,0.05) 0, transparent 55%),
        linear-gradient(180deg, #050718, #02030a 70%, #000);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 20px 18px 22px;
    }

    .search-title {
      font-size: .92rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      font-weight: 600;
      color: var(--sec-text-muted);
      margin-bottom: 6px;
    }

    .player-search-centered .search-wrapper {
      position: relative;
    }

    #playerSearch {
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(245,216,110,.7);
      background: rgba(2,4,18,0.95);
      color: #fff;
      font-size: .95rem;
    }

    #playerSearch::placeholder {
      color: rgba(180,183,216,0.75);
    }

    #searchResults {
      position:absolute;
      top: calc(100% + 6px);
      left: 0;
      width:100%;
      background:#090b17;
      border:1px solid rgba(255,215,0,.25);
      border-radius:14px;
      display:none;
      max-height:230px;
      overflow-y:auto;
      z-index:100;
    }

    .search-item {
      padding:9px 14px;
      color:#ddd;
      cursor:pointer;
    }

    .search-item:hover {
      background:rgba(255,215,0,.08);
      color:#f5d86e;
    }

    /* Footer */
    #sec-footer-wrapper {
      margin-top: 30px;
      padding-top: 18px;
      border-top: 1px solid rgba(214,177,95,0.35);
      text-align: center;
      font-size: 0.8rem;
      color: var(--sec-text-muted);
    }

    #sec-footer-wrapper span {
      color: var(--sec-gold-soft);
      font-weight: 600;
    }

    @media (max-width: 600px) {
      .player-search-centered {
        width: 90%;
      }
    }
  </style>
</head>

<body>

<!-- Bakgrund -->
<div id="sec-bg-layer">
  <div class="smoke-layer smoke-back"></div>
  <div class="smoke-layer"></div>
</div>

<div id="sec-page">

  <!-- üîô TILLBAKA-KNAPP -->
  <div class="back-button" onclick="history.back()">
    ‚Üê Tillbaka
  </div>

  <!-- HEADER -->
  <a href="index.html" style="text-decoration:none; color:inherit;">
    <div class="sfc-header">
        <img class="sfc-logo" src="https://drive.google.com/thumbnail?id=1QybW_Uw8HO0OXo8vwQFD-zrrr-ifFrC9&sz=w1000" alt="SEC Logo">
        <div class="sfc-title">
          üèÜ Svenska eHockey <strong>Cupen</strong> üèí
        </div>
        <div class="sfc-divider"></div>
    </div>
  </a>

  <div class="player-shell">
    <!-- SPELARKORT -->
    <div class="player-card">
      <img id="playerPhoto" alt="Spelarbild">
      <div id="playerName">Ingen spelare vald</div>

      <!-- üîπ NY LADDARE F√ñR STATISTIK -->
     <div id="statsLoader" class="stats-loader" style="
  display:none;
  margin: 20px auto;
  text-align:center;
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
">
  <div class="loader-text">Statistik laddas‚Ä¶</div>
  <div class="loader-bar">
    <div class="loader-bar-fill"></div>
  </div>
</div>


      <div id="statsOutput"></div>
    </div>

    <div id="loaderWrapper" class="loader-wrapper">
      <div class="sec-loader">
        <div class="stick left"></div>
        <div class="stick right"></div>
        <div class="puck"></div>
      </div>
    </div>

    <!-- S√ñKRUTA CENTRERAD -->
    <div class="player-search-centered">
      <div class="search-title">S√∂k</div>
      <div class="search-wrapper">
        <input id="playerSearch" placeholder="S√∂k PSN GT">
        <div id="searchResults"></div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div id="sec-footer-wrapper">
    ¬© 2025 <span>Svenska eHockey Cupen</span> | Design & utveckling av <span>SWEEHOCKEY</span>
  </div>

</div>
<script>
const API = "https://script.google.com/macros/s/AKfycbwUvylvIbUTy4_zihW5_OKIsQME2vxcPHWLldObZI28dggqJytvF2UmdsAD4Ib5Zre1/exec";

/* ==========================================================
   LOCALSTORAGE CACHE ‚Äì SUPERFAST PLAYER CACHE
   ========================================================== */

const CACHE_TIME = 10 * 60 * 1000; // 10 minuter

function cacheGet(player) {
  const key = "sec_player_" + player.toLowerCase();
  const raw = localStorage.getItem(key);
  if (!raw) return null;

  try {
    const obj = JSON.parse(raw);
    if (!obj.time || !obj.data) return null;

    // Utg√•ngen cache?
    if (Date.now() - obj.time > CACHE_TIME) {
      localStorage.removeItem(key);
      return null;
    }

    return obj.data;
  } catch {
    return null;
  }
}

function cacheSet(player, data) {
  const key = "sec_player_" + player.toLowerCase();
  localStorage.setItem(key, JSON.stringify({
    time: Date.now(),
    data: data
  }));
}


/* full team-map */
const TEAM_MAP={"3TU":"3Tuna Le sport","AL":"A Laget","AFT":"AFTERLIFE","AIS":"Almtuna ESPORT","AVE":"Avenyn Esport","BAC":"BACKCHECK BOYS","BAS":"Bask Nation","BEE":"Beerhouse","BGS":"Biggie Stockholm","BIK":"BIK Karlskoga Esport","BV":"Birka Vikings","IFB":"Bj√∂rkl√∂ven Esport","CLS":"Black Clovers","BES":"Black Eagles Sweden","Bla":"Black Panthers","BPS":"Black Phantoms","BD":"Blackdawgs","BSU":"Blessed Suedis","BOI":"BOIS IK","Bom":"Bombers Hockey","Boo":"Boost HC","BOR":"BortaMatch HC","BRA":"Brain Freezers","BB":"Brunker Bulldogs","BIF":"Bryn√§s IF Esport","Bul":"Bull sharks","CAL":"Calippo HC","ICE":"Carolus Icemen","CAV":"Cavemen Hockey","CHA":"Charleswood Chiefs","CHC":"Chiefzz HC","CLO":"Clowns","COG":"Company of Geeks","CRA":"Crash The Net HC","Dar":"Dark City Knights","DIC":"DICE Hockey","DTS":"Dirty Tacklers HC","DIF":"Djurg√•rden","DOM":"Dompa HC","DRA":"Dracones","DHY":"Dynamic Hockey","LXN":"E∆é Lag AntonLxnd","LGB":"E∆é Lag bystrom___","TCO":"E∆é Lag el_tacobag","LHZ":"E∆é Lag GD_Hampezz","FRY":"E∆é Lag l-Furyan-l","SLO":"E∆é Lag Sloogan9498","STG":"E∆é Lag Sneipthegunner","T50":"E∆é Lag Toivo4936","WAG":"E∆é Lag Wagge01","La":"E∆é Lag xAlknas","AC":"E∆é Lag xCurhed","Boe":"E∆é Lag xSnorlaaxx","EC":"Enkoping City","ENK":"Enk√∂ping Hks","EE":"Etuna Eagles","EVO":"Evolution HC","KBK":"F√§rjestad","FBK":"F√§rjestad BK","Far":"Farmalaget","FEM":"Favoritfemman","FEN":"Fenris Wolves","FIL":"Fila De La Hc","FF":"Fl√§die Faxes","FFR":"Free From Rodents","FHC":"Fr√∂lunda HC Academy","FR":"Fr√∂lunda HC Region","FSE":"Full send esport","GVL":"Gefle Bocken","GH":"Get Hagens HC","GIF":"Gifflarna HC","GB":"Glacies Bellator","GLA":"Glasbanken se","GHK":"Gleumes Hockey Krefeld","GD":"Green Devils","GHC":"Guldkallan HC","HAM":"Hamra Allstars","PE":"HC Pustertal Esports","HCZ":"HCZ","INC":"Hockey INC","HOC":"Hockey of the north","HP":"HockeyProfessorn HC","HRR":"Hokurit","HAW":"Hundred Acre Woods","HV":"HV71","Nld":"IFK Norrland","IKY":"IK EyBro","IKP":"Ik Pantern Esport","ISU":"Ik Stolpe ut","Ill":"Illumination","Ilu":"Illusion","JHC":"Jokers Hockey","KAJ":"KAJAK Esports","KAL":"KALMARUNIONEN","KNG":"Kingping","KXS":"Knox Stark","KP":"Kompaniet","KRK":"Kraken","OK":"Kronofogden Esport","KUM":"Kumla hockey","LOE":"Lack of Empathy","BYS":"Lag bystrom","AKE":"Lag Aker36","AND":"Lag andreaskakan","ANT":"Lag antoniomannen","AXE":"Lag Axelzonee","BEN":"Lag benjamint","BRU":"Lag Bruno_32","DAS":"Lag Dasplund","DII":"Lag Diizzylicious","ECK":"Lag eckeson","ELI":"Lag eliekamel_","EPS":"Lag ePsych0-","HEN":"Lag Henning92","LGH":"Lag Hojerslev","JAR":"Lag Jarvinder","JEP":"Lag Jepplo02","JON":"Lag Jonass1551","LAR":"Lag Larsson_500","LL":"Lag LaxenHD","LOK":"Lag Lokope11","LGL":"Lag LordOlii","MAT":"Lag Mathiasgamer_07","MES":"Lag mesimaki94","PRA":"Lag Prallelkova","LR":"Lag RookieLIAMOVIC","SNU":"Lag Snus","STE":"Lag Stenborg431","STI":"Lag stickovic","LGS":"Lag Svamp GG","TAB":"Lag Tablehockey","TAN":"Lag TantBerit","V1C":"Lag v1CTANK","LAL":"Lallare HC","LAM":"LAMPA","Las":"Las Palmas HC","CCN":"Le Club Chat Noir","LEG":"LEGION HC","LIF":"Leksand","LH":"Link√∂ping","LHC":"Lofoten HC","666":"Lucid Dreams","LLE":"Ludvika Lightning Esport","LHK":"Lule√•","LHF":"Lule√• Hockey Region","LUM":"Lumberjacks HC","MAC":"Macho","MAD":"MAD Knogmackers HC","MIF":"Malm√∂","FOG":"MG≈ÅA","MF":"Miami Freeze","Mel":"Mighty Mel HC","XXX":"Mighty Stixxx","MOD":"Modo Hockey","MIK":"Mora IK","MHC":"Morganchipsen HC","NWG":"No Worries Guys","NF":"Nordic Falcons","NK":"Nordic Knights","NKH":"Nordic Knights HC","NL":"Nordic Lightning","NOS":"Nordic Nosebleed","NOR":"Nordic Vipers","NVB":"Norra V√§sterbotten","NOF":"Norska f√∂rbundslaget","NHC":"North Hockey Academy","ND":"Northern Dust","NH":"Northern Heroes","Ock":"Ockelbo Ehockey","Olj":"Oljefondet","OME":"Omerta","omb":"Omerta beyond","ONT":"On The Road Again","One":"One HC","OBK":"√ñrebro","ODH":"Orebro deaf hockeY","OHA":"Orebro Hockey Academy","IKO":"Oskarshamn","OIK":"Oskarshamn IK","PAT":"Patriots","PHO":"Phoenix","POL":"Polarbears HC","PRO":"Prowlers Esport","PUR":"Purification","PC":"Purple Cobraas","RAE":"Rains It Poors","RHC":"Rava HC","RCT":"RCTIC","RNS":"Redemption Stars","ROP":"Rimon o Pumba","RGT":"Ringette HC","RBK":"R√∂gle","ROR":"Rorvik HC","RHT":"Royal HT","RPT":"RPEAT ESPORTS","SAN":"SandhedYoungGuns","SoS":"SCRUBS","SPT":"Serpentes","SHS":"Shifty Shafts","SHW":"Showtimes","112":"Sjukstugan","SAI":"Skellefte√•","Sku":"Skumtomtarnas arme","SW":"SPARTA WARRIORS1928","SPA":"Spartans eSport","SA":"SSK Academy","SSA":"SSK Adepts","SSK":"SSK eSport","SI":"SSK Ignite","SSP":"SSK Prospects","SBH":"Stallarholmens Brygghus","STR":"Starz HC","SAS":"Stayhard Stallions","BKN":"Stockholm Black Knights","SIL":"Storhamar IL Esport","SuS":"SUKAT JA SANDAALIT","SES":"Sunne IK Esport","SS":"Surte Sisu HC","SYN":"Synergy Hockey","TMO":"Team Modo","TR":"Team Rocket","TBT":"THE BLUE TELGE","TRB":"The red bullets","TRW":"THE RELENTLESS WOLFS HC","SOL":"The Solution","WoW":"The Worn Out Wisemen","TB":"Thigh Bay","TES":"TIGERS E-sport","TIK":"Timr√• IK","TRA":"Trasdockorna","TRE":"Troillan Esport","TRO":"Trojans","TUN":"Tundra","ULV":"Ulvhednar HC","UR":"UnderRated","UNI":"UNI Gaming","UN":"Unknown Heroes","UNW":"Unwanted","VAH":"Valbo hockey","VIK":"V√§ster√•s IK","VAX":"V√§xjo","VBS":"VBO B Stars","VBO":"VBO Stars","VER":"Verket","hmm":"Veterankraft","Vic":"Viccingi","VIP":"Viper hc","NEX":"vNexs Faxes","vNV":"vNexs Vipers","vNW":"VNexs wisemen","VS":"Vtuna Socken","WHI":"WHITE WINGS","WS":"Whitesharks","WIL":"Wild rockets Hc","WIS":"Wisby Islanders","You":"Young Guys"};

function teamName(code){ 
  return TEAM_MAP[code] || code; 
}

let allPlayers = [];

/* ============================================================
   SUPER-SNABB ALLPLAYERS ‚Äì localStorage cache (12 timmar)
============================================================ */
async function loadAllPlayersFast() {
  const CACHE_KEY = "secAllPlayers";
  const CACHE_TIME_KEY = "secAllPlayers_time";
  const MAX_AGE = 12 * 60 * 60 * 1000; // 12 timmar

  const loader = document.getElementById("loaderWrapper");

  // Visa loader endast vid API-h√§mtning
  loader.style.display = "flex";

  // üîπ 1) Kolla om cache finns och √§r f√§rsk
  const cached = localStorage.getItem(CACHE_KEY);
  const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

  if (cached && cachedTime && (Date.now() - cachedTime < MAX_AGE)) {
    allPlayers = JSON.parse(cached);
    loader.style.display = "none";
    return;
  }

  // üîπ 2) H√§mta fr√•n API om ingen cache finns
  try {
    const res = await fetch(API + "?allplayers=1");
    const data = await res.json();
    allPlayers = data;

    // üîπ Spara i cache
    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
    localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());

  } catch (err) {
    console.error("Fel vid laddning av allplayers:", err);
  }

  loader.style.display = "none";
}

loadAllPlayersFast();

/* Normalisera text */
function norm(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/[,]/g, "")
    .replace(/\s+/g, "")
    .replace(/[^a-z0-9]/g, "");
}

/* S√∂kning */
const inp = document.getElementById("playerSearch");
const box = document.getElementById("searchResults");

inp.addEventListener("input", () => {
  const q = norm(inp.value.trim());
  if (!q) { 
    box.style.display = "none"; 
    return; 
  }

  const results = allPlayers
    .filter(p => norm(p.PLAYER).includes(q))
    .slice(0, 20);

  box.innerHTML = results.length
    ? results.map(p => `<div class="search-item" onclick="go('${p.PLAYER}')">${p.PLAYER}</div>`).join("")
    : `<div class="search-item">F√∂rs√∂k igen om n√•gra sekunder</div>`;

  box.style.display = "block";
});

function go(name) {
  location.href = "?player=" + encodeURIComponent(name);
}

document.addEventListener("click", e => {
  if (!box.contains(e.target) && e.target !== inp) {
    box.style.display = "none";
  }
});

/* URL-param */
const params = new URLSearchParams(location.search);
const player = params.get("player") || "";
document.getElementById("playerName").textContent = player || "Ingen spelare vald";

/* Foto */
async function loadPhoto() {
  const res = await fetch(API + "?sheet=Spelarfoton");
  const rows = await res.json();
  const target = norm(player);
  const match = rows.find(r => norm(r.Spelarnamn) === target);
  const fallback = "1VAa79pJ-QbyeliY60autf914z6SBwmhp";
  const id = match ? match.DriveID : fallback;
  document.getElementById("playerPhoto").src =
    "https://drive.google.com/thumbnail?id=" + id + "&sz=w1000";
}

/* Format GAA */
function formatGAA(raw) {
  if (raw == null || raw === "") return "";
  if (typeof raw === "string" && raw.includes("T")) {
    const d = new Date(raw);
    if (!isNaN(d)) {
      const h = d.getUTCHours();
      const m = d.getUTCMinutes();
      const val = h + m / 60;
      return val.toFixed(2);
    }
  }
  const num = Number(raw);
  if (!isNaN(num)) return num.toFixed(2);
  return raw;
}

/* Format SV% 0.784 ‚Üí 78.4% */
function formatSVP(value) {
  if (!value) return "0%";

  // G√∂r om kommatecken till punkt
  let v = value.toString().replace(",", ".");

  let num = parseFloat(v);
  if (isNaN(num)) return "0%";

  // FALL 1: Normalt decimalformat 0.862 ‚Üí 86.2%
  if (num > 0 && num < 1) {
    return (num * 100).toFixed(1) + "%";
  }

  // FALL 2: Redan i procentform 86.2 ‚Üí 86.2%
  if (num >= 1 && num <= 100) {
    return num.toFixed(1) + "%";
  }

  // FALL 3: Onormalt stort tal (t.ex. 8923 ‚Üí 89.23%)
  if (num > 100) {
    return (num / 100).toFixed(2) + "%";
  }

  return num.toFixed(1) + "%";
}

/* =======================================================================================
   NATIONALITETER
======================================================================================= */
function translateNationality(code) {
  if (!code) return "";

  const map = {
    "SWE": "Svensk",
    "FIN": "Finsk",
    "NOR": "Norsk",
    "DEN": "Dansk",
    "DK": "Dansk",
    "GER": "Tysk",
    "DE": "Tysk",
    "FRA": "Fransk",
    "CZE": "Tjeckisk",
    "SVK": "Slovakisk",
    "SUI": "Schweizisk",
    "CHE": "Schweizisk",
    "AUT": "√ñsterrikisk",
    "LAT": "Lettisk",
    "EST": "Estnisk",
    "LTU": "Litauisk",
    "POL": "Polsk",
    "NLD": "Nederl√§ndsk",
    "NED": "Nederl√§ndsk",
    "GBR": "Brittisk",
    "ENG": "Engelsk"
  };

  code = code.trim().toUpperCase();
  return map[code] || code;
}

/* =======================================================================================
   Rensa turnering (tar bort G och S helt)
======================================================================================= */
function cleanTournament(t) {
  if (!t) return t;
  return t.replace(/\bG\b/g, "")
          .replace(/\bS\b/g, "")
          .replace(/\s+/g, " ")
          .trim();
}
// =============================
// CACHE F√ñR "VINNARE"-SHEET
// =============================
let winnersCache = null;

async function getWinners() {
  // 1) RAM-cache (snabbast)
  if (winnersCache) return winnersCache;

  // 2) sessionStorage-cache (√∂verlever sidomladdningar)
  try {
    const stored = sessionStorage.getItem("sec_winners_v1");
    if (stored) {
      winnersCache = JSON.parse(stored);
      return winnersCache;
    }
  } catch (e) {
    console.warn("Kunde inte l√§sa sessionStorage f√∂r vinnare:", e);
  }

  // 3) Om ingen cache: h√§mta fr√•n API
  const res = await fetch(API + "?sheet=vinnare");
  const winData = await res.json();

  winnersCache = winData;

  // Spara till sessionStorage f√∂r n√§sta sidladdning
  try {
    sessionStorage.setItem("sec_winners_v1", JSON.stringify(winData));
  } catch (e) {
    console.warn("Kunde inte skriva till sessionStorage f√∂r vinnare:", e);
  }

  return winData;
}

/* ============================================================
   ULTRASNABB + CACHE-OPTIMERAD LOADSTATS()
   ============================================================ */

async function loadStats() {
  const out = document.getElementById("statsOutput");
  const loaderStats = document.getElementById("statsLoader");

  if (!player) {
    out.innerHTML = `<div class="no-stats">Ingen spelare vald.</div>`;
    out.style.display = "block";
    return;
  }

  loaderStats.style.display = "block";
  out.style.display = "none";

  try {
    /* ======================================================
       1Ô∏è‚É£ F√ñRS√ñK L√ÑSA FR√ÖN CACHE F√ñRST (10 min TTL)
       ====================================================== */
    let bundle = cacheGet(player);

    /* ======================================================
       2Ô∏è‚É£ H√ÑMTA FR√ÖN API ENDAST OM CACHE SAKNAS
       ====================================================== */
    if (!bundle) {
      const url = API + "?bundle=1&player=" + encodeURIComponent(player);
      const res = await fetch(url);
      bundle = await res.json();

      // Spara i cache om det √§r ett legitimt svar
      if (bundle && bundle.stats && !bundle.error && bundle.stats.length > 0) {
        cacheSet(player, bundle);
      }
    }

    /* ======================================================
       3Ô∏è‚É£ FELHANTERING ‚Äì inga stats hittades
       ====================================================== */
    if (!bundle || bundle.error || !bundle.stats || bundle.stats.length === 0) {
      out.innerHTML = `<div class="no-stats">Ingen statistik hittades.</div>`;
      out.style.display = "block";
      loaderStats.style.display = "none";
      return;
    }

    /* ======================================================
       4Ô∏è‚É£ READ DATA
       ====================================================== */
    const originalData = bundle.stats;
    const winners = bundle.winners || [];
    const photoId = bundle.photoId || "1VAa79pJ-QbyeliY60autf914z6SBwmhp";

    /* ======================================================
       5Ô∏è‚É£ FOTO
       ====================================================== */
    const img = document.getElementById("playerPhoto");
    img.src = `https://drive.google.com/thumbnail?id=${photoId}&sz=w1000`;
    img.loading = "eager";

    /* NORMALISERING AV TURNERING */
    originalData.forEach(r => {
      r.TURNERING = r.TURNERING
        .replace(/G$/, "G")
        .replace(/S$/, "S")
        .replace(/\s+G$/, " G")
        .replace(/\s+S$/, " S");
    });

    /* ======================================================
       6Ô∏è‚É£ SPELARNAMN + NATIONALITET
       ====================================================== */
    let rawName = originalData[0].PLAYER || originalData[0].GOALIES || player;
    rawName = String(rawName);

    let cleanName = rawName.includes(",") ? rawName.split(",")[0].trim() : rawName;
    let natCode   = rawName.includes(",") ? rawName.split(",")[1].trim() : "";
    let nationality = translateNationality(natCode);

    document.getElementById("playerName").textContent = cleanName;

    /* ======================================================
       7Ô∏è‚É£ CUPER, LAG & MATCHER
       ====================================================== */
    const cups = [...new Set(originalData.map(r => r.TURNERING))]
      .sort((a, b) => parseFloat(a.replace("SEC", "")) - parseFloat(b.replace("SEC", "")));

    const firstCup = cups[0];
    const lastCup  = cups[cups.length - 1];
    const playedOnce = cups.length === 1;

    const firstTeam = teamName(originalData.find(r => r.TURNERING === firstCup).TEAM);
    const lastTeam  = teamName(originalData.find(r => r.TURNERING === lastCup).TEAM);

    const totalGames = originalData.reduce((sum, r) => sum + Number(r.GP || 0), 0);

    /* ======================================================
       8Ô∏è‚É£ B√ÑSTA CUP ‚Äì SKATERS & GOALIES
       ====================================================== */
    const skaters = originalData.filter(r => !("SA" in r));
    const goalies = originalData.filter(r => ("SA" in r));

    const bestSkater =
      skaters.length ? skaters.reduce((b, r) => (r.PTS > (b?.PTS || -1) ? r : b), null) : null;

    const bestGoalie =
      goalies.length
        ? goalies.reduce((b, r) => {
            const sv = parseFloat(String(r.SVP).replace(",", "."));
            const bs = b ? parseFloat(String(b.SVP).replace(",", ".")) : -1;
            return sv > bs ? r : b;
          }, null)
        : null;

    function formatSVP_Value(v) {
      let num = parseFloat(String(v).replace(",", "."));
      if (num < 1) num *= 100;
      return num.toFixed(1) + "%";
    }

    /* ======================================================
       9Ô∏è‚É£ B√ÑSTA CUP ‚Äî TEXT
       ====================================================== */
    let bestCupText = "";

    if (playedOnce) {
      if (bestSkater) {
        bestCupText += `
          Som utespelare gjorde han sin b√§sta insats i <strong>${bestSkater.TURNERING}</strong>
          med <strong>${bestSkater.PTS}</strong> po√§ng f√∂r <strong>${teamName(bestSkater.TEAM)}</strong>.<br>`;
      }
      if (bestGoalie) {
        bestCupText += `
          Som m√•lvakt var han som b√§st i <strong>${bestGoalie.TURNERING}</strong>
          med en r√§ddningsprocent p√• <strong>${formatSVP_Value(bestGoalie.SVP)}</strong>
          f√∂r <strong>${teamName(bestGoalie.TEAM)}</strong>.`;
      }
    } else {
      if (bestSkater) {
        bestCupText += `
          Den b√§sta cupen han spelade som utespelare var <strong>${bestSkater.TURNERING}</strong>,
          d√§r han gjorde <strong>${bestSkater.PTS}</strong> po√§ng f√∂r <strong>${teamName(bestSkater.TEAM)}</strong>.<br>`;
      }
      if (bestGoalie) {
        bestCupText += `
          Som m√•lvakt var hans b√§sta cup <strong>${bestGoalie.TURNERING}</strong>
          d√§r han hade sin b√§sta SV% p√• <strong>${formatSVP_Value(bestGoalie.SVP)}</strong>
          f√∂r <strong>${teamName(bestGoalie.TEAM)}</strong>.`;
      }
    }

    /* ======================================================
       üîü MERITER ‚Äì M√ÑSTARE & 2:A
       ====================================================== */
    let meritText = "";

    winners.forEach(w => {
      if (!w.cup) return;

      const num = w.cup.replace("SEC", "").trim();
      const row = originalData.find(r =>
        r.TURNERING.replace("SEC", "").trim().startsWith(num)
      );
      if (!row) return;

      const tm = teamName(row.TEAM).toLowerCase();
      const winTeam = w["1a"]?.toLowerCase();
      const ruTeam  = w["2a"]?.toLowerCase();

      if (tm === winTeam) meritText += `üèÜ Han √§r <strong>M√§stare i SEC ${num}</strong>.<br>`;
      if (tm === ruTeam)  meritText += `ü•à Han kom <strong>2:a i SEC ${num}</strong>.<br>`;
    });

    /* ======================================================
       1Ô∏è‚É£1Ô∏è‚É£ BIO TEXT
       ====================================================== */
    let bioText = `
      <div style="margin-top:10px;margin-bottom:20px;color:#ddd;font-size:0.95rem;line-height:1.55;">
        <strong>${cleanName}</strong> √§r en <strong>${nationality}</strong> eHockey-spelare
        som gjorde sitt f√∂rsta framtr√§dande i <strong>${firstCup}</strong> f√∂r <strong>${firstTeam}</strong>.
    `;

    if (playedOnce) {
      bioText += `Han har endast spelat en enda SEC-cup ‚Äì <strong>${firstCup}</strong>.`;
    } else {
      bioText += `
        Totalt har han deltagit i <strong>${cups.length}</strong> cuper och representerat
        <strong>${new Set(originalData.map(r => r.TEAM)).size}</strong> lag.
        I den senaste upplagan <strong>${lastCup}</strong> spelade han f√∂r <strong>${lastTeam}</strong>.`;
    }

    bioText += `
        Totalt har han spelat <strong>${totalGames}</strong> matcher i SEC.
        <br><br>${bestCupText}<br><br>${meritText}
      </div>
    `;

    /* ======================================================
       1Ô∏è‚É£2Ô∏è‚É£ STATSBLOCK ‚Äì HTML
       ====================================================== */
    let html = bioText;

    if (skaters.length) {
      html += `
        <h3 style="margin-top:25px;color:#f5d86e;">Utespelare</h3>
        <div class="stats-table">
          <table><thead>
            <tr><th>TURNERING</th><th>TEAM</th><th>GP</th><th>G</th><th>A</th><th>PTS</th><th>PIM</th></tr>
          </thead><tbody>`;
      skaters.forEach(r => {
        html += `
          <tr>
            <td>${r.TURNERING}</td>
            <td>${teamName(r.TEAM)}</td>
            <td>${r.GP}</td>
            <td>${r.G}</td>
            <td>${r.A}</td>
            <td>${r.PTS}</td>
            <td>${r.PIM}</td>
          </tr>`;
      });
      html += `</tbody></table></div>`;
    }

    if (goalies.length) {
      html += `
        <h3 style="margin-top:25px;color:#f5d86e;">M√•lvakt</h3>
        <div class="stats-table">
          <table><thead>
            <tr><th>TURNERING</th><th>TEAM</th><th>GP</th><th>SA</th><th>GA</th><th>SV</th><th>GAA</th><th>SV%</th><th>SO</th></tr>
          </thead><tbody>`;
      goalies.forEach(r => {
        html += `
          <tr>
            <td>${r.TURNERING}</td>
            <td>${teamName(r.TEAM)}</td>
            <td>${r.GP}</td>
            <td>${r.SA}</td>
            <td>${r.GA}</td>
            <td>${r.SV}</td>
            <td>${formatGAA(r.GAA)}</td>
            <td>${formatSVP(r.SVP)}</td>
            <td>${r.SO}</td>
          </tr>`;
      });
      html += `</tbody></table></div>`;
    }

    /* ======================================================
       1Ô∏è‚É£3Ô∏è‚É£ VISA RESULTAT
       ====================================================== */
    out.innerHTML = html;
    out.style.display = "block";
    loaderStats.style.display = "none";
  }

  catch (err) {
    console.error("Stats error:", err);
    loaderStats.style.display = "none";
    out.innerHTML = `<div class="no-stats">Fel vid laddning.</div>`;
    out.style.display = "block";
  }
}


/* INITIERA */
loadPhoto();
loadStats();
</script>

</body>
</html>
